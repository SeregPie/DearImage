!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).DearImage=e()}(this,(function(){"use strict";function t(t,e){try{return Object.assign(document.createElement("canvas"),{width:t,height:e})}catch{}throw new Error("HTMLCanvasElement is not supported.")}function e(t,e){try{return new OffscreenCanvas(t,e)}catch{}throw new Error("OffscreenCanvas is not supported.")}function n(...n){try{return t(...n)}catch{}try{return e(...n)}catch{}return function(t,e){try{let{Canvas:n}=require("canvas");return new n(t,e)}catch{}throw new Error("Canvas is not supported.")}(...n)}function r(...t){return n(...t).getContext("2d")}class i{static is(t){return t instanceof this}constructor(t){this.context=t}get canvas(){return this.context.canvas}get sizeX(){return this.canvas.width}get sizeY(){return this.canvas.height}}function a(t){return Number.isFinite(t)&&!function(t){return t<0}(t)}function o(t){return"string"==typeof t}function s(t,e){return o(t)&&(t=Number(t)),a(t)?Math.round(t):e}function u(t){return s(t,0)}function c(t,e){return Math.ceil(t/e)*e}function l(t){if(t){let e=typeof t;return"object"===e||"function"===e}return!1}function f(t){let{CanvasGradient:e}=globalThis;return!!e&&t instanceof e||function(t){try{let{CanvasGradient:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function h(t){let{CanvasPattern:e}=globalThis;return!!e&&t instanceof e||function(t){try{let{CanvasPattern:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function p(t,e){return f(t)||h(t)?t:function(t,e){if(o(t)){let e=r(0,0);{let n="#000000";if(e.fillStyle=n,e.fillStyle=t,e.fillStyle!==n)return e.fillStyle}{let n="#ffffff";if(e.fillStyle=n,e.fillStyle=t,e.fillStyle!==n)return e.fillStyle}}return e}(t,e)}function d(t,e){return o(t)&&(t=Number(t)),Number.isFinite(t)?Math.round(t):e}function g(t){return d(t,0)}function m(t){if(o(t))return t.trim().toLowerCase()}function y(t){return function(t){let{HTMLCanvasElement:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){let{OffscreenCanvas:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){try{let{Canvas:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function w(t,e,n){let i=r(e,n);return e&&n&&i.drawImage(t,0,0),i}function v(t){return w(t,t.width,t.height)}function z({canvas:t}){return v(t)}async function b(t){return await async function(t){if(!t.complete)try{await new Promise(((e,n)=>{t.onload=e,t.onerror=n}))}finally{t.onload=null,t.onerror=null}}(t),function(t){return w(t,t.naturalWidth,t.naturalHeight)}(t)}function I(t){return function(t){let{HTMLImageElement:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){try{let{Image:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function x(t){let{ImageData:e}=globalThis;return!!e&&t instanceof e||function(t){try{let{ImageData:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function C(t){let{CanvasRenderingContext2D:e}=globalThis;return!!e&&t instanceof e||function(t){try{let{CanvasRenderingContext2D:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function M(t){return C(t)||function(t){let{WebGL2RenderingContext:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){let{WebGLRenderingContext:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){let{ImageBitmapRenderingContext:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){let{OffscreenCanvasRenderingContext2D:e}=globalThis;return!!e&&t instanceof e}(t)}function T(t){if(i.is(t))return z(t);if(x(t))return function(t){let{height:e,width:n}=t,i=r(n,e);return n&&e&&i.putImageData(t,0,0),i}(t);if(y(t))return v(t);if(M(t))return z(t);if(I(t))return b(t);throw new Error("Failed to create a CanvasRenderingContext2D instance from the given value.")}function X(t){try{return Object.assign(new Image,{src:t})}catch{}throw new Error("HTMLImageElement is not supported.")}function Y(...t){try{return X(...t)}catch{}return function(t){try{let{Image:e}=require("canvas");return Object.assign(new e,{src:t})}catch{}throw new Error("Image is not supported.")}(...t)}async function L(t){let e=Y(t);return await b(e)}async function R(t){return await L(`${t}`)}async function D(t){return t.isEmpty()?r(0,0):await R(t)}i.blank=function(t,e){return new this(r(t=u(t),e=u(e)))},i.filled=function(t,e,n){let r=this.blank(e,n);if(({sizeX:e,sizeY:n}=r),(t=p(t))&&e&&n){let{context:i}=r;i.save(),i.fillStyle=t,i.fillRect(0,0,e,n),i.restore()}return r},i.prototype.crop=function(t,e,n,r){let{canvas:i,sizeX:a,sizeY:o}=this;if(t=g(t),e=g(e),n=d(n,a),e<0&&(e+=o),t<0&&(t+=a),(r=d(r,o))<0&&(e+=r,r*=-1),n<0&&(t+=n,n*=-1),t||e||n!==a||r!==o){let s=this.constructor.blank(n,r);if(n&&r&&a&&o){let{context:n}=s;n.drawImage(i,-t,-e)}return s}return this},i.prototype.reframe=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;t=s(t,i),e=s(e,a),n=m(n),r=m(r);let o=-(()=>{switch(n){case"start":return 0;case"end":return t}return(i+t)/2})(),u=-(()=>{switch(r){case"start":return 0;case"end":return e}return(a+e)/2})();return this.crop(o,u,t,e)},i.from=function(t){if(this.is(t))return t;return new this(T(t))},i.fromExcept=(()=>{let t=!0;return function(...e){return t&&(console.warn("[DearImage] The function `.fromExcept` is deprecated. Please use `.from` instead."),t=!1),this.from.call(this,...e)}})(),i.drawed=function(t,e,n,r){let a,o,s,u,f=this.blank(e,n);if(({sizeX:e,sizeY:n}=f),t=function(t){try{let e=i.from(t);if(e.sizeX&&e.sizeY)return e}catch{}}(t),(t=>{l(t)&&((t=>{l(t)?(a=t.x,o=t.y):a=o=t})(t.alignment),(t=>{l(t)?(s=t.x,u=t.y):s=u=t})(t.repeat))})(r),t&&e&&n){let{canvas:r}=i.filled(l.createPattern(t.canvas,s&&u?"repeat":s?"repeat-x":u?"repeat-y":"no-repeat"),c(e,t.sizeX),c(n,t.sizeY)).reframe(e,n,a,o),{context:l}=f;l.drawImage(r,0,0)}return f},i.isDearImage=i.is.bind(i);class E{static is(t){return t instanceof this}static isString(t){try{return this.parse(t),!0}catch{return!1}}static parse(t){if(o(t)){let e=/^data:(.*?)(;base64)?,(.*)$/.exec(t);if(e){let n=e[1],r=e[2],i=e[3];return Object.assign(new this,{type:n,encoded:r,data:i,toString:()=>t})}}throw new Error("Invalid data URL.")}isEmpty(){return!this.data}}function O(t){let{URL:e}=globalThis;return!!e&&t instanceof e}async function k(t){return o(t)?await async function(t){try{let e=E.parse(t);return await D(e)}catch{}return await L(t)}(t):O(t)?await R(t):E.is(t)?await D(t):function(t){let{Buffer:e}=globalThis;return!!e&&t instanceof e}(t)?await async function(t){return t.length?await L(t):r(0,0)}(t):function(t){let{Blob:e}=globalThis;return!!e&&t instanceof e}(t)?await async function(t){if(!t.size)return r(0,0);let e=URL.createObjectURL(t);try{return await L(e)}finally{URL.revokeObjectURL(e)}}(t):I(t)?await b(t):T(t)}function U(t,...e){return function(...n){return t.call(this,...e,...n)}}function S(t,e,n){let{canvas:r,sizeX:a,sizeY:o}=this;if(a&&o){let t=this.constructor.blank(a,o),{canvas:s}=i.drawed(e,a,o,n),{context:u}=t;return u.drawImage(r,0,0),u.drawImage(s,0,0),t}return this}function B(t,e){let{canvas:n,sizeX:r,sizeY:i}=this;if(r&&i){let a=this.constructor.blank(r,i),{context:o}=a;return o.save(),o.translate(t?r:0,e?i:0),o.scale(t?-1:1,e?-1:1),o.drawImage(n,0,0),o.restore(),a}return this}function F(t){return function(t,e){return o(t)&&(t=Number(t)),a(t)?t:e}(t,1)}function j(t,e,n){let{sizeX:r,sizeY:i}=this;e=s(e,r),n=s(n,i);let a=[];if(e&&r){let t=e/r;a.push(t)}if(n&&i){let t=n/i;a.push(t)}if(a.length){let e=t(a);return this.scale(e)}return this}function q(t){return function(t,e){return o(t)&&(t=Number(t)),Number.isFinite(t)?t:e}(t,0)%(2*Math.PI)}i.loadFrom=async function(t){if(this.is(t))return t;return new this(await k(t))},i.loadFromExcept=(()=>{let t=!0;return function(...e){return t&&(console.warn("[DearImage] The function `.loadFromExcept` is deprecated. Please use `.loadFrom` instead."),t=!1),this.loadFrom.call(this,...e)}})(),Object.assign(i.prototype,{drawBackground:U(S,!1),drawForeground:U(S,!0)}),i.prototype.drawCheckeredBackground=function(){return this},i.prototype.fillBackground=function(t){let{sizeX:e,sizeY:n}=this;return this.drawBackground(this.constructor.filled(t,e,n))},i.prototype.fillForeground=function(t){let{sizeX:e,sizeY:n}=this;return this.drawForeground(this.constructor.filled(t,e,n))},Object.assign(i.prototype,{flipX:U(B,!0,!1),flipY:U(B,!1,!0)}),i.prototype.toImageData=function(){let{context:t,sizeX:e,sizeY:n}=this;return t.getImageData(0,0,e,n)},i.prototype.isBlank=function(){let{sizeX:t,sizeY:e}=this;return!(t&&e&&this.toImageData().data.some((t=>t)))},i.prototype.resize=function(t,e){let{canvas:n,sizeX:r,sizeY:i}=this;if(t=s(t,r),e=s(e,i),t!==r||e!==i){let a=this.constructor.blank(t,e);if(t&&e&&r&&i){let o=t/r,s=e/i,{context:u}=a;u.save(),u.scale(o,s),u.drawImage(n,0,0),u.restore()}return a}return this},i.prototype.rescale=function(t,e){let{sizeX:n,sizeY:r}=this;t=F(t),e=F(e);let i=Math.round(n*t),a=Math.round(r*e);return this.resize(i,a)},i.prototype.scale=function(t){return this.rescale(t,t)},Object.assign(i.prototype,{scaleDownIn:U(j,(t=>Math.min(Math.min(...t),1))),scaleDownOut:U(j,(t=>Math.min(Math.max(...t),1))),scaleIn:U(j,(t=>Math.min(...t))),scaleOut:U(j,(t=>Math.max(...t))),scaleUpIn:U(j,(t=>Math.max(Math.min(...t),1))),scaleUpOut:U(j,(t=>Math.max(Math.max(...t),1)))}),i.prototype.reframeScaleIn=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;return t=s(t,i),e=s(e,a),this.scaleIn(t,e).reframe(t,e,n,r)},i.prototype.reframeScaleOut=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;return t=s(t,i),e=s(e,a),this.scaleOut(t,e).reframe(t,e,n,r)},i.prototype.resizeX=function(t,e){let{sizeX:n,sizeY:r}=this;if(t=s(t,n),e){if(n){let e=t/n;return this.scale(e)}return this}return this.resize(t,r)},i.prototype.resizeY=function(t,e){let{sizeX:n,sizeY:r}=this;if(t=s(t,r),e){if(r){let e=t/r;return this.scale(e)}return this}return this.resize(n,t)},i.prototype.rotate=function(t){let{canvas:e,sizeX:n,sizeY:r}=this;if((t=q(t))&&n&&r){let i=Math.abs(Math.cos(t)),a=Math.abs(Math.sin(t)),o=Math.round(n*i+r*a),s=Math.round(n*a+r*i),u=this.constructor.blank(o,s),{context:c}=u;return c.save(),c.translate(o/2,s/2),c.rotate(t),c.drawImage(e,-n/2,-r/2),c.restore(),u}return this};var P=Math.PI/2;i.prototype.rotateClockwise=function(){return this.rotate(P)};var H=-P;function N(t){try{return function(t){try{if(o(t)){let{URL:e}=globalThis;if(e){let{document:n}=globalThis;return n?new e(t,n.location.origin):new e(t)}}}catch{}throw new Error("Invalid URL.")}(t),!0}catch{return!1}}return i.prototype.rotateCounterClockwise=function(){return this.rotate(H)},i.prototype.toBuffer=function(...t){let{canvas:e,sizeX:n,sizeY:r}=this;return n&&r?e.toBuffer(...t):Buffer.alloc(0)},i.prototype.saveToFileSystem=function(t,...e){return new Promise(((n,r)=>{let i=require("fs"),a=require("path"),o=this.toBuffer(...e);i.mkdir(a.dirname(t),{recursive:!0},(e=>{e?r(e):i.writeFile(t,o,(t=>{t?r(t):n()}))}))}))},i.prototype.toDataURL=function(...t){let{canvas:e}=this;return e.toDataURL(...t)},i.prototype.toBlob=function(...t){let{data:e,type:n}=E.parse(this.toDataURL(...t)),r=function(t){let{length:e}=t,n=new Uint8Array(e);for(let r=0;r<e;r++)n[r]=t.charCodeAt(r);return n}(atob(e));return new Blob([r],{type:n})},i.prototype.toHTMLCanvasElement=function(){let{canvas:e,sizeX:n,sizeY:r}=this,i=t(n,r);return n&&r&&i.getContext("2d").drawImage(e,0,0),i},i.prototype.toHTMLImageElement=function(...t){return X(this.toDataURL(...t))},i.prototype.toOffscreenCanvas=function(){let{canvas:t,sizeX:n,sizeY:r}=this,i=e(n,r);return n&&r&&i.getContext("2d").drawImage(t,0,0),i},i.utils={},i.utils.isDataURL=function(t){return E.isString(t)},i.utils.isURL=function(t){return O(t)||N(t)},i}));

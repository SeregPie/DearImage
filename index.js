!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).DearImage=n()}(this,(function(){"use strict";var t=function(t){this.context=t},n={canvas:{configurable:!0},sizeX:{configurable:!0},sizeY:{configurable:!0}};function r(){try{return document.createElement("canvas")}catch(t){}throw new Error("HTMLCanvasElement is not supported.")}function e(){try{return new OffscreenCanvas}catch(t){}throw new Error("OffscreenCanvas is not supported.")}function i(){try{return r()}catch(t){}try{return e()}catch(t){}return function(){try{return new(0,require("canvas").Canvas)}catch(t){}throw new Error("Canvas is not supported.")}()}function a(t){return Number.isFinite(t)&&t>0}function s(t){return function(t){var n=globalThis.HTMLCanvasElement;return!!n&&t instanceof n}(t)||function(t){var n=globalThis.OffscreenCanvas;return!!n&&t instanceof n}(t)||function(t){try{return t instanceof require("canvas").Canvas}catch(t){}return!1}(t)}function o(t){return"string"==typeof t}n.canvas.get=function(){return this.context.canvas},n.sizeX.get=function(){return this.canvas.width},n.sizeY.get=function(){return this.canvas.height},Object.defineProperties(t.prototype,n),t.blank=function(t,n){t=a(t)?Math.round(t):0,n=a(n)?Math.round(n):0;var r=i();return r.width=t,r.height=n,new this(r.getContext("2d"))},t.is=function(t){return t instanceof this};var u=/^data:(.*?)(;base64)?,(.*)$/;var c={is:function(t){return t instanceof this},isString:function(t){return!!this.parse(t)},parse:function(t){if(o(t)){var n=u.exec(t);if(n){var r=n[1],e=n[3];return Object.assign(new this,{type:r,data:e,toString:function(){return t}})}}return!1}};var f={isEmpty:function(){return!this.data}},h=function(){return function(){}}(),l=h.prototype;function p(){try{return new Image}catch(t){}throw new Error("HTMLImageElement is not supported.")}function v(){try{return p()}catch(t){}return function(){try{return new(0,require("canvas").Image)}catch(t){}throw new Error("Image is not supported.")}()}function m(t){return function(t){var n=globalThis.HTMLImageElement;return!!n&&t instanceof n}(t)||function(t){try{return t instanceof require("canvas").Image}catch(t){}return!1}(t)}function g(t){return new Promise((function(n){n(t())}))}function d(t){var n=globalThis.ImageData;return!!n&&t instanceof n||function(t){try{return t instanceof require("canvas").ImageData}catch(t){}return!1}(t)}function y(t){var n=globalThis.URL;return!!n&&t instanceof n}Object.assign(h,c),Object.assign(l,f);var z=function(t){var n=this.blank(t.width,t.height);return n.sizeX&&n.sizeY&&n.context.putImageData(t,0,0),n},w=function(t,n,r){var e=this.blank(n,r);return e.sizeX&&e.sizeY&&e.context.drawImage(t,0,0),e},b=function(t){return w.call(this,t,t.width,t.height)},M=function(t){return w.call(this,t,t.naturalWidth,t.naturalHeight)},x=function(t){return b.call(this,t.canvas)},X=function(n){if(t.is(n))return x.call(this,n);if(d(n))return z.call(this,n);if(s(n))return b.call(this,n);if(m(n))return M.call(this,n);throw new Error},Y=function(t){var n,r=this;return(n=t,g((function(){if(!n.complete)return new Promise((function(t,r){n.onload=t,n.onerror=r})).finally((function(){n.onload=null,n.onerror=null}))}))).then((function(){return M.call(r,t)}))},I=function(t){var n=v();return n.src=t,Y.call(this,n)},L=function(t){return t.length?I.call(this,t):this.blank()},C=function(t){var n=this;if(!t.size)return this.blank();var r=URL.createObjectURL(t);return g((function(){return I.call(n,r)})).finally((function(){URL.revokeObjectURL(r)}))},E=function(t){return t.isEmpty()?this.blank():I.call(this,""+t)},O=function(t){var n=h.parse(t);return n?E.call(this,n):I.call(this,t)},T=function(t){return I.call(this,""+t)};function j(t){if(t){var n=typeof t;return"object"===n||"function"===n}return!1}Object.assign(t,{from:X,loadFrom:function(t){var n=this;return g((function(){return o(t)?O.call(n,t):y(t)?T.call(n,t):function(t){var n=globalThis.Buffer;return!!n&&t instanceof n}(t)?L.call(n,t):function(t){var n=globalThis.Blob;return!!n&&t instanceof n}(t)?C.call(n,t):m(t)?Y.call(n,t):X.call(n,t)}))}}),t.fromExcept=function(t){return this.is(t)?t:this.from(t)},t.isDearImage=t.is.bind(t);function F(t){return o(t)&&!function(t){return!t}(t)}function U(t){return F(t)?t:"sans-serif"}var D=new Set(["normal","italic","oblique"]);var S=new Set(["normal","small-caps"]);function k(t){return"number"==typeof t&&!Number.isNaN(t)}function R(t,n,r,e,i){return(e?t>=n:t>n)&&(i?t<=r:t<r)}var q=new Set(["normal","bold"]);function B(t){if(o(t)){if(t=t.trim().toLowerCase(),q.has(t))return t}else if(function(t){for(var n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];return k(t)&&R.apply(void 0,[t].concat(n))}(t,1,1e3,!0,!0))return t=Math.round(t);return"normal"}var N={from:function(t){var n="sans-serif",r="normal",e="normal",i="normal";return o(t)?n=U(t):j(t)&&(n=U(t.family),r=function(t){return o(t)&&(t=t.trim().toLowerCase(),D.has(t))?t:"normal"}(t.style),e=function(t){return o(t)&&(t=t.trim().toLowerCase(),S.has(t))?t:"normal"}(t.variant),i=B(t.weight)),Object.assign(new this,{family:n,style:r,variant:e,weight:i})},fromExcept:function(t){return this.is(t)?t:this.from(t)},is:function(t){return t instanceof this}};function H(t,n,r,e,i){return[r,e,i,n+"px",t].join(" ")}function P(){}function A(t){return function(t){return void 0===t}(t)||function(t){return null===t}(t)}var W={load:function(t){var n=this;return g((function(){var r=n,e=r.family,i=r.style,a=r.variant,s=r.weight;if(A(t))try{return document.fonts.load(H(e,10,i,a,s))}catch(t){}else{try{return new FontFace(e,t,{style:i,variant:a,weight:s}).load()}catch(t){}try{return(0,require("canvas").registerFont)(t,{family:e,style:i,variant:a,weight:s})}catch(t){}}})).then(P)}},$=function(){return function(){}}(),G=$.prototype;Object.assign($,N),$.default=$.from(),Object.assign(G,W),t.loadFontFace=function(t,n){return g((function(){return $.fromExcept(t).load(n)}))},t.loadFromExcept=function(t){var n=this;return g((function(){return n.is(t)?t:n.loadFrom(t)}))};function J(t){return Number.isFinite(t)&&!function(t){return t<0}(t)}var K={from:function(t){var n=$.default,r=10;j(t)&&(n=$.from(t),r=function(t){return J(t)?t=Math.round(t):10}(t.size));var e=n.family,i=n.style,a=n.variant,s=n.weight;return Object.assign(new this,{family:e,size:r,style:i,variant:a,weight:s})},fromExcept:function(t){return this.is(t)?t:this.from(t)},is:function(t){return t instanceof this}};var Q={toCSS:function(){return H(this.family,this.size,this.style,this.variant,this.weight)}},V=function(){return function(){}}(),Z=V.prototype;function _(t){for(var n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];return function(){for(var r=[],e=arguments.length;e--;)r[e]=arguments[e];return t.call.apply(t,[this].concat(n,r))}}Object.assign(V,K),V.default=V.from(),Object.assign(Z,Q),t.measureText=function(t,n){t=A(t)?"":""+t;var r=this.blank().context;return r.font=V.fromExcept(n).toCSS(),r.measureText(t)},t.text=function(t,n){t=A(t)?"":""+t;var r="#000",e=V.default,i=.28;j(n)&&(F(n.fill)&&(r=n.fill),e=V.fromExcept(n.font),J(n.padding)&&(i=n.padding)),i=Math.ceil(i*e.size);var a=this.blank(this.measureText(t,e).width+2*i,e.size+2*i),s=a.context;return s.save(),s.font=e.toCSS(),s.textBaseline="top",s.textAlign="left",s.fillStyle=r,s.fillText(t,i,i),s.restore(),a},t.prototype.crop=function(t,n,r,e){if(Number.isFinite(t)?(t=Math.round(t))<0&&(t+=this.sizeX):t=0,Number.isFinite(n)?(n=Math.round(n))<0&&(n+=this.sizeY):n=0,Number.isFinite(r)?(r=Math.round(r))<0&&(t+=r,r*=-1):(this,r=this.sizeX),Number.isFinite(e)?(e=Math.round(e))<0&&(n+=e,e*=-1):(this,e=this.sizeY),t||n||r!==this.sizeX||e!==this.sizeY){var i=this.constructor.blank(r,e);return r&&e&&this.sizeX&&this.sizeY&&i.context.drawImage(this.canvas,-t,-n),i}return this};var tt=function(t,n){var r=this.sizeX,e=this.sizeY;if(r&&e){var i=this.constructor.blank(r,e),a=i.context;return a.save(),a.translate(t?r:0,n?e:0),a.scale(t?-1:1,n?-1:1),a.drawImage(this.canvas,0,0),a.restore(),i}return this};Object.assign(t.prototype,{flipX:_(tt,!0,!1),flipY:_(tt,!1,!0)}),t.prototype.reframe=function(t,n,r,e){var i=this;J(t)?t=Math.round(t):(this,t=this.sizeX),J(n)?n=Math.round(n):(this,n=this.sizeY);var a=function(){if(o(r))switch(r.trim().toLowerCase()){case"start":return 0;case"end":return-t}return(i.sizeX+t)/-2}(),s=function(){if(o(e))switch(e.trim().toLowerCase()){case"start":return 0;case"end":return-n}return(i.sizeY+n)/-2}();return this.crop(a,s,t,n)},t.prototype.resize=function(t,n){if(J(t)?t=Math.round(t):(this,t=this.sizeX),J(n)?n=Math.round(n):(this,n=this.sizeY),t!==this.sizeX||n!==this.sizeY){var r=this.constructor.blank(t,n);if(t&&n&&this.sizeX&&this.sizeY){var e=t/this.sizeX,i=n/this.sizeY,a=r.context;a.save(),a.scale(e,i),a.drawImage(this.canvas,0,0),a.restore()}return r}return this},t.prototype.rescale=function(t,n){var r=this.sizeX,e=this.sizeY;return J(t)&&(r*=t),J(n)&&(e*=n),this.resize(r,e)},t.prototype.scale=function(t){return this.rescale(t,t)},t.prototype.resizeX=function(t,n){return n?this.sizeX&&J(t)?(t=Math.round(t),this.scale(t/this.sizeX)):this:this.resize(t,this.sizeY)},t.prototype.resizeY=function(t,n){return n?this.sizeY&&J(t)?(t=Math.round(t),this.scale(t/this.sizeY)):this:this.resize(this.sizeX,t)},t.prototype.toBuffer=function(){for(var t,n=[],r=arguments.length;r--;)n[r]=arguments[r];return this.sizeX&&this.sizeY?(t=this.canvas).toBuffer.apply(t,n):Buffer.alloc(0)},t.prototype.saveToFileSystem=function(t){for(var n=this,r=[],e=arguments.length-1;e-- >0;)r[e]=arguments[e+1];return new Promise((function(e,i){var a,s=require("fs"),o=require("path"),u=(a=n).toBuffer.apply(a,r);s.mkdir(o.dirname(t),{recursive:!0},(function(n){n?i(n):s.writeFile(t,u,(function(t){t?i(t):e()}))}))}))};var nt=function(t,n,r){J(n)?n=Math.round(n):(this,n=this.sizeX),J(r)?r=Math.round(r):(this,r=this.sizeY);var e=[];if(n&&this.sizeX){var i=n/this.sizeX;e.push(i)}if(r&&this.sizeY){var a=r/this.sizeY;e.push(a)}if(e.length){var s=t(e);return this.scale(s)}return this};function rt(t){for(var n=t.length,r=new Uint8Array(n),e=0;e<n;e++)r[e]=t.charCodeAt(e);return r}function et(t){return!!function(t){if(o(t)){var n=globalThis.URL;if(n){var r=globalThis.document,e=r&&r.location&&r.location.origin;try{return new n(t,e)}catch(t){}}}return!1}(t)}return Object.assign(t.prototype,{scaleDownIn:_(nt,(function(t){return Math.min(Math.min.apply(Math,t),1)})),scaleDownOut:_(nt,(function(t){return Math.min(Math.max.apply(Math,t),1)})),scaleIn:_(nt,(function(t){return Math.min.apply(Math,t)})),scaleOut:_(nt,(function(t){return Math.max.apply(Math,t)})),scaleUpIn:_(nt,(function(t){return Math.max(Math.min.apply(Math,t),1)})),scaleUpOut:_(nt,(function(t){return Math.max(Math.max.apply(Math,t),1)}))}),t.prototype.toDataURL=function(){for(var t,n=[],r=arguments.length;r--;)n[r]=arguments[r];return(t=this.canvas).toDataURL.apply(t,n)},t.prototype.toBlob=function(){for(var t,n=[],r=arguments.length;r--;)n[r]=arguments[r];var e=h.parse((t=this).toDataURL.apply(t,n)),i=e.data,a=e.type,s=rt(atob(i));return new Blob([s],{type:a})},t.prototype.toHTMLCanvasElement=function(){var t=r(),n=this.sizeX,e=this.sizeY;return t.width=n,t.height=e,n&&e&&t.getContext("2d").drawImage(this.canvas,0,0),t},t.prototype.toHTMLImageElement=function(){for(var t,n=[],r=arguments.length;r--;)n[r]=arguments[r];var e=p();return e.src=(t=this).toDataURL.apply(t,n),e},t.prototype.toImageData=function(){return this.context.getImageData(0,0,this.sizeX,this.sizeY)},t.prototype.toOffscreenCanvas=function(){var t=e(),n=this.sizeX,r=this.sizeY;return t.width=n,t.height=r,n&&r&&t.getContext("2d").drawImage(this.canvas,0,0),t},(t.utils={}).isDataURL=function(t){return h.is(t)||h.isString(t)},t.utils.isURL=function(t){return y(t)||et(t)},t}));

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).DearImage=e()}(this,(function(){"use strict";function t(t){return eval("require")(t)}function e(e,n){try{let{Canvas:r}=t("canvas");return new r(e,n)}catch{}throw new Error("Canvas is not supported.")}function n(t,e){try{return Object.assign(document.createElement("canvas"),{width:t,height:e})}catch{}throw new Error("HTMLCanvasElement is not supported.")}function r(t,e){try{return new OffscreenCanvas(t,e)}catch{}throw new Error("OffscreenCanvas is not supported.")}function i(...t){try{return n(...t)}catch{}try{return r(...t)}catch{}return e(...t)}function a(...t){return i(...t).getContext("2d")}class o{static is(t){return t instanceof this}constructor(t){this.context=t}get canvas(){return this.context.canvas}get sizeX(){return this.canvas.width}get sizeY(){return this.canvas.height}}function s(t){return t<0}function u(t){return!s(t)}function c(t){return Number.isFinite(t)&&u(t)}let f=t=>{if(c(t=Number(t)))return Math.round(t)};function l(e){try{let{Canvas:n}=t("canvas");return e instanceof n}catch{}return!1}function h(t){let{HTMLCanvasElement:e}=globalThis;return!!e&&t instanceof e}function p(t){let{OffscreenCanvas:e}=globalThis;return!!e&&t instanceof e}function m(t){return h(t)||p(t)||l(t)}function g(t,e,n){let r=a(e,n);return e&&n&&r.drawImage(t,0,0),r}function d(t){return g(t,t.width,t.height)}function y({canvas:t}){return d(t)}function w(t){return g(t,t.naturalWidth,t.naturalHeight)}async function b(t){if(!t.complete)try{await new Promise((e,n)=>{t.onload=e,t.onerror=n})}finally{t.onload=null,t.onerror=null}}async function v(t){return await b(t),w(t)}function z(t){let{height:e,width:n}=t,r=a(n,e);return n&&e&&r.putImageData(t,0,0),r}function M(t){let{HTMLImageElement:e}=globalThis;return!!e&&t instanceof e}function I(e){try{let{Image:n}=t("canvas");return e instanceof n}catch{}return!1}function C(t){return M(t)||I(t)}function x(e){try{let{ImageData:n}=t("canvas");return e instanceof n}catch{}return!1}function L(t){let{ImageData:e}=globalThis;return!!e&&t instanceof e||x(t)}function T(e){try{let{CanvasRenderingContext2D:n}=t("canvas");return e instanceof n}catch{}return!1}function R(t){let{CanvasRenderingContext2D:e}=globalThis;return!!e&&t instanceof e||T(t)}function O(t){let{ImageBitmapRenderingContext:e}=globalThis;return!!e&&t instanceof e}function X(t){let{WebGL2RenderingContext:e}=globalThis;return!!e&&t instanceof e}function Y(t){let{WebGLRenderingContext:e}=globalThis;return!!e&&t instanceof e}function D(t){return R(t)||X(t)||Y(t)||O(t)}function E(t){if(o.is(t))return y(t);if(L(t))return z(t);if(m(t))return d(t);if(D(t))return y(t);if(C(t))return v(t);throw new Error("Failed to create a CanvasRenderingContext2D instance from the given value.")}function U(t){let{Blob:e}=globalThis;return!!e&&t instanceof e}function N(t){let{Buffer:e}=globalThis;return!!e&&t instanceof e}function j(t){return!t.size}function k(t){try{return Object.assign(new Image,{src:t})}catch{}throw new Error("HTMLImageElement is not supported.")}function B(e){try{let{Image:n}=t("canvas");return Object.assign(new n,{src:e})}catch{}throw new Error("Image is not supported.")}function F(...t){try{return k(...t)}catch{}return B(...t)}async function H(t){let e=F(t);return await v(e)}async function S(t){if(j(t))return a(0,0);let e=URL.createObjectURL(t);try{return await H(e)}finally{URL.revokeObjectURL(e)}}function P(t){return!t.length}async function W(t){return P(t)?a(0,0):await H(t)}async function A(t){return await H(""+t)}async function G(t){return t.isEmpty()?a(0,0):await A(t)}o.blank=function(t,e){return[t=0,e=0]=[f(t),f(e)],new this(a(t,e))},o.from=function(t){if(this.is(t))return t;return new this(E(t))},o.isDearImage=o.is.bind(o);class q{}function $(t){return t instanceof this}function J(t){try{return this.parse(t),!0}catch{return!1}}function K(t){return"string"==typeof t}var Q=/^data:(.*?)(;base64)?,(.*)$/;function V(t){if(K(t)){let e=Q.exec(t);if(e){let n=e[1],r=e[2],i=e[3];return Object.assign(new this,{type:n,encoded:r,data:i,toString:()=>t})}}throw new Error("Invalid data URL.")}var Z={is:$,isString:J,parse:V};function _(){return!this.data}var tt={isEmpty:_};let{prototype:et}=q;async function nt(t){try{let e=q.parse(t);return await G(e)}catch{}return await H(t)}function rt(t){let{URL:e}=globalThis;return!!e&&t instanceof e}async function it(t){return K(t)?await nt(t):rt(t)?await A(t):q.is(t)?await G(t):N(t)?await W(t):U(t)?await S(t):C(t)?await v(t):E(t)}Object.assign(q,Z),Object.assign(et,tt),o.loadFrom=async function(t){if(this.is(t))return t;return new this(await it(t))};let at=function(t){if(t=Number(t),Number.isFinite(t))return Math.round(t)},ot=at;function st(t,...e){return function(...n){return t.call(this,...e,...n)}}o.prototype.crop=function(t,e,n,r){let{canvas:i,sizeX:a,sizeY:o}=this;if([n=a,r=o,t=0,e=0]=[ot(n),ot(r),at(t),at(e)],e<0&&(e+=o),t<0&&(t+=a),r<0&&(e+=r,r*=-1),n<0&&(t+=n,n*=-1),t||e||n!==a||r!==o){let s=this.constructor.blank(n,r);if(n&&r&&a&&o){let{context:n}=s;n.drawImage(i,-t,-e)}return s}return this};let ut=function(t,e){let{canvas:n,sizeX:r,sizeY:i}=this;if(r&&i){let a=this.constructor.blank(r,i),{context:o}=a;return o.save(),o.translate(t?r:0,e?i:0),o.scale(t?-1:1,e?-1:1),o.drawImage(n,0,0),o.restore(),a}return this};Object.assign(o.prototype,{flipX:st(ut,!0,!1),flipY:st(ut,!1,!0)}),o.prototype.toImageData=function(){let{context:t,sizeX:e,sizeY:n}=this;return t.getImageData(0,0,e,n)},o.prototype.isBlank=function(){let{sizeX:t,sizeY:e}=this;return!(t&&e&&this.toImageData().data.some(t=>t))};let ct=function(t){if(c(t=Number(t)))return Math.round(t)},ft=function(t){if(K(t))return t.trim().toLowerCase()};o.prototype.reframe=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;[n,r,t=i,e=a]=[ft(n),ft(r),ct(t),ct(e)];let o=(()=>{switch(n){case"start":return 0;case"end":return-t}return(i+t)/-2})(),s=(()=>{switch(r){case"start":return 0;case"end":return-e}return(a+e)/-2})();return this.crop(o,s,t,e)};let lt=function(t){if(c(t=Number(t)))return Math.round(t)};o.prototype.resize=function(t,e){let{canvas:n,sizeX:r,sizeY:i}=this;if([t=r,e=i]=[lt(t),lt(e)],t!==r||e!==i){let a=this.constructor.blank(t,e);if(t&&e&&r&&i){let o=t/r,s=e/i,{context:u}=a;u.save(),u.scale(o,s),u.drawImage(n,0,0),u.restore()}return a}return this};let ht=function(t){if(c(t=Number(t)))return t};o.prototype.rescale=function(t,e){let{sizeX:n,sizeY:r}=this;[t=1,e=1]=[ht(t),ht(e)];let i=n*t,a=r*e;return this.resize(i,a)},o.prototype.scale=function(t){return this.rescale(t,t)};let pt=function(t){if(c(t=Number(t)))return Math.round(t)},mt=function(t,e,n){let{sizeX:r,sizeY:i}=this;[e=r,n=i]=[pt(e),pt(n)];let a=[];if(e&&r){let t=e/r;a.push(t)}if(n&&i){let t=n/i;a.push(t)}if(a.length){let e=t(a);return this.scale(e)}return this};Object.assign(o.prototype,{scaleDownIn:st(mt,t=>Math.min(Math.min(...t),1)),scaleDownOut:st(mt,t=>Math.min(Math.max(...t),1)),scaleIn:st(mt,t=>Math.min(...t)),scaleOut:st(mt,t=>Math.max(...t)),scaleUpIn:st(mt,t=>Math.max(Math.min(...t),1)),scaleUpOut:st(mt,t=>Math.max(Math.max(...t),1))});let gt=function(t){if(c(t=Number(t)))return Math.round(t)};o.prototype.reframeScaleIn=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;return[t=i,e=a]=[gt(t),gt(e)],this.scaleIn(t,e).reframe(t,e,n,r)};let dt=function(t){if(c(t=Number(t)))return Math.round(t)};o.prototype.reframeScaleOut=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;return[t=i,e=a]=[dt(t),dt(e)],this.scaleOut(t,e).reframe(t,e,n,r)};let yt=function(t){if(c(t=Number(t)))return Math.round(t)};o.prototype.resizeX=function(t,e){let{sizeX:n,sizeY:r}=this;if([t=n]=[yt(t)],e){let e=t/n;return this.scale(e)}return this.resize(t,r)};let wt=function(t){if(c(t=Number(t)))return Math.round(t)};o.prototype.resizeY=function(t,e){let{sizeX:n,sizeY:r}=this;if([t=r]=[wt(t)],e){let e=t/r;return this.scale(e)}return this.resize(n,t)};let bt=function(t){if(t=Number(t),Number.isFinite(t))return t%(2*Math.PI)};function vt(t){let{length:e}=t,n=new Uint8Array(e);for(let r=0;r<e;r++)n[r]=t.charCodeAt(r);return n}function zt(t){try{if(K(t)){let{URL:e}=globalThis;if(e){let{document:n}=globalThis;return n?new e(t,n.location.origin):new e(t)}}}catch{}throw new Error("Invalid URL.")}function Mt(t){try{return zt(t),!0}catch{return!1}}return o.prototype.rotate=function(t){let{canvas:e,sizeX:n,sizeY:r}=this;if([t=0]=[bt(t)],t&&n&&r){let i=Math.abs(Math.cos(t)),a=Math.abs(Math.sin(t)),o=Math.round(n*i+r*a),s=Math.round(n*a+r*i),u=this.constructor.blank(o,s),{context:c}=u;return c.save(),c.translate(o/2,s/2),c.rotate(t),c.drawImage(e,-n/2,-r/2),c.restore(),u}return this},o.prototype.rotateClockwise=function(){return this.rotate(+Math.PI/2)},o.prototype.rotateCounterClockwise=function(){return this.rotate(-Math.PI/2)},o.prototype.toBuffer=function(...t){let{canvas:e,sizeX:n,sizeY:r}=this;return n&&r?e.toBuffer(...t):Buffer.alloc(0)},o.prototype.saveToFileSystem=function(e,...n){return new Promise((r,i)=>{let a=t("fs"),o=t("path"),s=this.toBuffer(...n);a.mkdir(o.dirname(e),{recursive:!0},t=>{t?i(t):a.writeFile(e,s,t=>{t?i(t):r()})})})},o.prototype.toDataURL=function(...t){let{canvas:e}=this;return e.toDataURL(...t)},o.prototype.toBlob=function(...t){let{data:e,type:n}=q.parse(this.toDataURL(...t)),r=vt(atob(e));return new Blob([r],{type:n})},o.prototype.toHTMLCanvasElement=function(){let{canvas:t,sizeX:e,sizeY:r}=this,i=n(e,r);return e&&r&&i.getContext("2d").drawImage(t,0,0),i},o.prototype.toHTMLImageElement=function(...t){return k(this.toDataURL(...t))},o.prototype.toOffscreenCanvas=function(){let{canvas:t,sizeX:e,sizeY:n}=this,i=r(e,n);return e&&n&&i.getContext("2d").drawImage(t,0,0),i},o.utils={},o.utils.isDataURL=function(t){return q.isString(t)},o.utils.isURL=function(t){return rt(t)||Mt(t)},o}));

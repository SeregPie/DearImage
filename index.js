!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).DearImage=n()}(this,(function(){"use strict";function t(t){return eval("require")(t)}function n(n,e){try{let{Canvas:r}=t("canvas");return Object.assign(new r,{width:n,height:e})}catch{}throw new Error("Canvas is not supported.")}function e(t,n){try{return Object.assign(document.createElement("canvas"),{width:t,height:n})}catch{}throw new Error("HTMLCanvasElement is not supported.")}function r(t,n){try{return Object.assign(new OffscreenCanvas,{width:t,height:n})}catch{}throw new Error("OffscreenCanvas is not supported.")}function i(...t){try{return e(...t)}catch{}try{return r(...t)}catch{}return n(...t)}function a(...t){return i(...t).getContext("2d")}class o{static is(t){return t instanceof this}constructor(t){this.context=t}get canvas(){return this.context.canvas}get sizeX(){return this.canvas.width}get sizeY(){return this.canvas.height}}function u(t){if(t){let n=typeof t;return"object"===n||"function"===n}return!1}function s(t){return"string"==typeof t}function c(t){return t<0}function f(t){return!c(t)}function l(t){return Number.isFinite(t)&&f(t)}function h(t,n){if(u(t)){if(l(t=Number(String(t))))return Math.round(t)}else if(s(t)){if(l(t=Number(t)))return Math.round(t)}else if(l(t))return Math.round(t);return n}function g(t){return h(t,0)}function p(n){try{let{CanvasGradient:e}=t("canvas");return n instanceof e}catch{}return!1}function m(t){let{CanvasGradient:n}=globalThis;return!!n&&t instanceof n||p(t)}function d(n){try{let{CanvasPattern:e}=t("canvas");return n instanceof e}catch{}return!1}function y(t){let{CanvasPattern:n}=globalThis;return!!n&&t instanceof n||d(t)}function b(t,n){return m(t)||y(t),t}function w(n){try{let{Canvas:e}=t("canvas");return n instanceof e}catch{}return!1}function v(t){let{HTMLCanvasElement:n}=globalThis;return!!n&&t instanceof n}function z(t){let{OffscreenCanvas:n}=globalThis;return!!n&&t instanceof n}function M(t){return v(t)||z(t)||w(t)}function C(t,n,e){let r=a(n,e);return n&&e&&r.drawImage(t,0,0),r}function I(t){return C(t,t.width,t.height)}function x({canvas:t}){return I(t)}function L(t){return C(t,t.naturalWidth,t.naturalHeight)}async function T(t){if(!t.complete)try{await new Promise((n,e)=>{t.onload=n,t.onerror=e})}finally{t.onload=null,t.onerror=null}}async function O(t){return await T(t),L(t)}function R(t){let{height:n,width:e}=t,r=a(e,n);return e&&n&&r.putImageData(t,0,0),r}function N(t){let{HTMLImageElement:n}=globalThis;return!!n&&t instanceof n}function X(n){try{let{Image:e}=t("canvas");return n instanceof e}catch{}return!1}function Y(t){return N(t)||X(t)}function D(n){try{let{ImageData:e}=t("canvas");return n instanceof e}catch{}return!1}function E(t){let{ImageData:n}=globalThis;return!!n&&t instanceof n||D(t)}function U(n){try{let{CanvasRenderingContext2D:e}=t("canvas");return n instanceof e}catch{}return!1}function j(t){let{CanvasRenderingContext2D:n}=globalThis;return!!n&&t instanceof n||U(t)}function F(t){let{ImageBitmapRenderingContext:n}=globalThis;return!!n&&t instanceof n}function S(t){let{WebGL2RenderingContext:n}=globalThis;return!!n&&t instanceof n}function k(t){let{WebGLRenderingContext:n}=globalThis;return!!n&&t instanceof n}function B(t){return j(t)||S(t)||k(t)||F(t)}function H(t){if(o.is(t))return x(t);if(E(t))return R(t);if(M(t))return I(t);if(B(t))return x(t);if(Y(t))return O(t);throw new Error("Failed to create a CanvasRenderingContext2D instance from the given value.")}function P(t){let{Blob:n}=globalThis;return!!n&&t instanceof n}function G(t){let{Buffer:n}=globalThis;return!!n&&t instanceof n}function W(t){return!t.size}function A(t){try{return Object.assign(new Image,{src:t})}catch{}throw new Error("HTMLImageElement is not supported.")}function q(n){try{let{Image:e}=t("canvas");return Object.assign(new e,{src:n})}catch{}throw new Error("Image is not supported.")}function $(...t){try{return A(...t)}catch{}return q(...t)}async function J(t){let n=$(t);return await O(n)}async function K(t){if(W(t))return a(0,0);let n=URL.createObjectURL(t);try{return await J(n)}finally{URL.revokeObjectURL(n)}}function Q(t){return!t.length}async function V(t){return Q(t)?a(0,0):await J(t)}async function Z(t){return await J(""+t)}async function _(t){return t.isEmpty()?a(0,0):await Z(t)}o.blank=function(t,n){return new this(a(t=g(t),n=g(n)))},o.filled=function(t,n,e){t=b(t);let r=this.blank(n,e);if(({sizeX:n,sizeY:e}=r),t&&n&&e){let{context:i}=r;i.save(),i.fillStyle=t,i.fillRect(0,0,n,e),i.restore()}return r},o.flexLayout=function(){return this},o.from=function(t){if(this.is(t))return t;return new this(H(t))},o.gridLayout=function(){return this},o.isDearImage=o.is.bind(o);class tt{}function nt(t){return t instanceof this}function et(t){try{return this.parse(t),!0}catch{return!1}}var rt=/^data:(.*?)(;base64)?,(.*)$/;function it(t){if(s(t)){let n=rt.exec(t);if(n){let e=n[1],r=n[2],i=n[3];return Object.assign(new this,{type:e,encoded:r,data:i,toString:()=>t})}}throw new Error("Invalid data URL.")}var at={is:nt,isString:et,parse:it};function ot(){return!this.data}var ut={isEmpty:ot};let{prototype:st}=tt;async function ct(t){try{let n=tt.parse(t);return await _(n)}catch{}return await J(t)}function ft(t){let{URL:n}=globalThis;return!!n&&t instanceof n}async function lt(t){return s(t)?await ct(t):ft(t)?await Z(t):tt.is(t)?await _(t):G(t)?await V(t):P(t)?await K(t):Y(t)?await O(t):H(t)}function ht(t,n){if(u(t)){if(t=Number(String(t)),Number.isFinite(t))return Math.round(t)}else if(s(t)){if(t=Number(t),Number.isFinite(t))return Math.round(t)}else if(Number.isFinite(t))return Math.round(t);return n}function gt(t,n){if(u(t)){if(t=Number(String(t)),Number.isFinite(t))return Math.round(t)}else if(s(t)){if(t=Number(t),Number.isFinite(t))return Math.round(t)}else if(Number.isFinite(t))return Math.round(t);return n}function pt(t){return gt(t,0)}function mt(t,n,e){return(t=pt(t))<0&&(t+=e),(n=ht(n,e))<0&&(t+=n,n*=-1),[t,n]}function dt(t,...n){return function(...e){return t.call(this,...n,...e)}}Object.assign(tt,at),Object.assign(st,ut),o.loadFrom=async function(t){if(this.is(t))return t;return new this(await lt(t))},o.prototype.crop=function(t,n,e,r){let{canvas:i,sizeX:a,sizeY:o}=this;if([t,e]=mt(t,e,a),[n,r]=mt(n,r,o),t||n||e!==a||r!==o){let u=this.constructor.blank(e,r);if(e&&r&&a&&o){let{context:e}=u;e.drawImage(i,-t,-n)}return u}return this};let yt=function(t,n){let{canvas:e,sizeX:r,sizeY:i}=this;if(r&&i){let a=this.constructor.blank(r,i),{context:o}=a;return o.save(),o.translate(t?r:0,n?i:0),o.scale(t?-1:1,n?-1:1),o.drawImage(e,0,0),o.restore(),a}return this};function bt(t,n){return u(t)?(t=String(t)).trim().toLowerCase():s(t)?t.trim().toLowerCase():n}function wt(t,n,e){switch(t=bt(t)){case"start":return 0;case"end":return-n}return(e+n)/-2}function vt(t,n,e){return[wt(t,n=h(n,e),e),n]}function zt(t,n){if(u(t)){if(l(t=Number(String(t))))return t}else if(s(t)){if(l(t=Number(t)))return t}else if(l(t))return t;return n}function Mt(t){return zt(t,1)}function Ct(t,n){return n*(t=Mt(t))}function It(t,n,e){if((n=h(n,e))&&e){let r=n/e;t.push(r)}}Object.assign(o.prototype,{flipX:dt(yt,!0,!1),flipY:dt(yt,!1,!0)}),o.prototype.toImageData=function(){let{context:t,sizeX:n,sizeY:e}=this;return t.getImageData(0,0,n,e)},o.prototype.isBlank=function(){let{sizeX:t,sizeY:n}=this;return!(t&&n&&this.toImageData().data.some(t=>t))},o.prototype.reframe=function(t,n,e,r){let i,a,{sizeX:o,sizeY:u}=this;return[i,t]=vt(e,t,o),[a,n]=vt(r,n,u),this.crop(i,a,t,n)},o.prototype.resize=function(t,n){let{canvas:e,sizeX:r,sizeY:i}=this;if(t=h(t,r),n=h(n,i),t!==r||n!==i){let a=this.constructor.blank(t,n);if(t&&n&&r&&i){let o=t/r,u=n/i,{context:s}=a;s.save(),s.scale(o,u),s.drawImage(e,0,0),s.restore()}return a}return this},o.prototype.rescale=function(t,n){let{sizeX:e,sizeY:r}=this,i=Ct(t,e),a=Ct(n,r);return this.resize(i,a)},o.prototype.scale=function(t){return this.rescale(t,t)};let xt=function(t,n,e){let{sizeX:r,sizeY:i}=this,a=[];if(It(a,n,r),It(a,e,i),a.length){let n=t(a);return this.scale(n)}return this};function Lt(t,n){if(u(t)){if(t=Number(String(t)),Number.isFinite(t))return t}else if(s(t)){if(t=Number(t),Number.isFinite(t))return t}else if(Number.isFinite(t))return t;return n}function Tt(t){return Lt(t,0)%(2*Math.PI)}Object.assign(o.prototype,{scaleDownIn:dt(xt,t=>Math.min(Math.min(...t),1)),scaleDownOut:dt(xt,t=>Math.min(Math.max(...t),1)),scaleIn:dt(xt,t=>Math.min(...t)),scaleOut:dt(xt,t=>Math.max(...t)),scaleUpIn:dt(xt,t=>Math.max(Math.min(...t),1)),scaleUpOut:dt(xt,t=>Math.max(Math.max(...t),1))}),o.prototype.reframeScaleIn=function(t,n,e,r){let{sizeX:i,sizeY:a}=this;return t=h(t,i),n=h(n,a),this.scaleIn(t,n).reframe(t,n,e,r)},o.prototype.reframeScaleOut=function(t,n,e,r){let{sizeX:i,sizeY:a}=this;return t=h(t,i),n=h(n,a),this.scaleOut(t,n).reframe(t,n,e,r)},o.prototype.resizeX=function(t,n){let{sizeX:e,sizeY:r}=this;if(t=h(t,e),n){let n=t/e;return this.scale(n)}return this.resize(t,r)},o.prototype.resizeY=function(t,n){let{sizeX:e,sizeY:r}=this;if(t=h(t,r),n){let n=t/r;return this.scale(n)}return this.resize(e,t)},o.prototype.rotate=function(t){let{canvas:n,sizeX:e,sizeY:r}=this;if((t=Tt(t))&&e&&r){let i=Math.abs(Math.cos(t)),a=Math.abs(Math.sin(t)),o=Math.round(e*i+r*a),u=Math.round(e*a+r*i),s=this.constructor.blank(o,u),{context:c}=s;return c.save(),c.translate(o/2,u/2),c.rotate(t),c.drawImage(n,-e/2,-r/2),c.restore(),s}return this};var Ot=Math.PI/2;o.prototype.rotateClockwise=function(){return this.rotate(Ot)};var Rt=-Ot;function Nt(t){let{length:n}=t,e=new Uint8Array(n);for(let r=0;r<n;r++)e[r]=t.charCodeAt(r);return e}function Xt(t){try{if(s(t)){let{URL:n}=globalThis;if(n){let{document:e}=globalThis;return e?new n(t,e.location.origin):new n(t)}}}catch{}throw new Error("Invalid URL.")}function Yt(t){try{return Xt(t),!0}catch{return!1}}return o.prototype.rotateCounterClockwise=function(){return this.rotate(Rt)},o.prototype.toBuffer=function(...t){let{canvas:n,sizeX:e,sizeY:r}=this;return e&&r?n.toBuffer(...t):Buffer.alloc(0)},o.prototype.saveToFileSystem=function(n,...e){return new Promise((r,i)=>{let a=t("fs"),o=t("path"),u=this.toBuffer(...e);a.mkdir(o.dirname(n),{recursive:!0},t=>{t?i(t):a.writeFile(n,u,t=>{t?i(t):r()})})})},o.prototype.toDataURL=function(...t){let{canvas:n}=this;return n.toDataURL(...t)},o.prototype.toBlob=function(...t){let{data:n,type:e}=tt.parse(this.toDataURL(...t)),r=Nt(atob(n));return new Blob([r],{type:e})},o.prototype.toHTMLCanvasElement=function(){let{canvas:t,sizeX:n,sizeY:r}=this,i=e(n,r);return n&&r&&i.getContext("2d").drawImage(t,0,0),i},o.prototype.toHTMLImageElement=function(...t){return A(this.toDataURL(...t))},o.prototype.toOffscreenCanvas=function(){let{sizeX:t,sizeY:n}=this,e=r(t,n);return t&&n&&e.getContext("2d").drawImage(this.canvas,0,0),e},o.utils={},o.utils.isDataURL=function(t){return tt.isString(t)},o.utils.isURL=function(t){return ft(t)||Yt(t)},o}));

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).DearImage=e()}(this,(function(){"use strict";function t(t){return eval("require")(t)}function e(e,n){try{let{Canvas:r}=t("canvas");return new r(e,n)}catch{}throw new Error("Canvas is not supported.")}function n(t,e){try{return Object.assign(document.createElement("canvas"),{width:t,height:e})}catch{}throw new Error("HTMLCanvasElement is not supported.")}function r(t,e){try{return new OffscreenCanvas(t,e)}catch{}throw new Error("OffscreenCanvas is not supported.")}function i(...t){try{return n(...t)}catch{}try{return r(...t)}catch{}return e(...t)}function a(...t){return i(...t).getContext("2d")}class o{static is(t){return t instanceof this}constructor(t){this.context=t}get canvas(){return this.context.canvas}get sizeX(){return this.canvas.width}get sizeY(){return this.canvas.height}}function s(t){return null!=t?t:0}function c(t,e){return Math.ceil(t/e)*e}function u(t){if(t){let e=typeof t;return"object"===e||"function"===e}return!1}function l(e){try{let{CanvasGradient:n}=t("canvas");return e instanceof n}catch{}return!1}function f(t){let{CanvasGradient:e}=globalThis;return!!e&&t instanceof e||l(t)}function h(e){try{let{CanvasPattern:n}=t("canvas");return e instanceof n}catch{}return!1}function p(t){let{CanvasPattern:e}=globalThis;return!!e&&t instanceof e||h(t)}function d(t){if(null!=t)return f(t)||p(t),t}function g(t,e){return null!=t?t:e}function m(t){return null!=t?t:0}function w(t){return"string"==typeof t}function y(t){if(w(t))return t.trim().toLowerCase()}function v(t,e){return null!=t?t:e}function z(e){try{let{Canvas:n}=t("canvas");return e instanceof n}catch{}return!1}function b(t){let{HTMLCanvasElement:e}=globalThis;return!!e&&t instanceof e}function I(t){let{OffscreenCanvas:e}=globalThis;return!!e&&t instanceof e}function x(t){return b(t)||I(t)||z(t)}function C(t,e,n){let r=a(e,n);return e&&n&&r.drawImage(t,0,0),r}function T(t){return C(t,t.width,t.height)}function X({canvas:t}){return T(t)}function Y(t){return C(t,t.naturalWidth,t.naturalHeight)}async function M(t){if(!t.complete)try{await new Promise(((e,n)=>{t.onload=e,t.onerror=n}))}finally{t.onload=null,t.onerror=null}}async function L(t){return await M(t),Y(t)}function R(t){let{height:e,width:n}=t,r=a(n,e);return n&&e&&r.putImageData(t,0,0),r}function D(t){let{HTMLImageElement:e}=globalThis;return!!e&&t instanceof e}function E(e){try{let{Image:n}=t("canvas");return e instanceof n}catch{}return!1}function O(t){return D(t)||E(t)}function k(e){try{let{ImageData:n}=t("canvas");return e instanceof n}catch{}return!1}function U(t){let{ImageData:e}=globalThis;return!!e&&t instanceof e||k(t)}function B(e){try{let{CanvasRenderingContext2D:n}=t("canvas");return e instanceof n}catch{}return!1}function j(t){let{CanvasRenderingContext2D:e}=globalThis;return!!e&&t instanceof e||B(t)}function F(t){let{ImageBitmapRenderingContext:e}=globalThis;return!!e&&t instanceof e}function P(t){let{OffscreenCanvasRenderingContext2D:e}=globalThis;return!!e&&t instanceof e}function H(t){let{WebGL2RenderingContext:e}=globalThis;return!!e&&t instanceof e}function S(t){let{WebGLRenderingContext:e}=globalThis;return!!e&&t instanceof e}function G(t){return j(t)||H(t)||S(t)||F(t)||P(t)}function W(t){if(o.is(t))return X(t);if(U(t))return R(t);if(x(t))return T(t);if(G(t))return X(t);if(O(t))return L(t);throw new Error("Failed to create a CanvasRenderingContext2D instance from the given value.")}function A(t){try{let e=o.from(t);if(e.sizeX&&e.sizeY)return e}catch{}}function q(t){let{Blob:e}=globalThis;return!!e&&t instanceof e}function $(t){let{Buffer:e}=globalThis;return!!e&&t instanceof e}function J(t){return!t.size}function K(t){try{return Object.assign(new Image,{src:t})}catch{}throw new Error("HTMLImageElement is not supported.")}function N(e){try{let{Image:n}=t("canvas");return Object.assign(new n,{src:e})}catch{}throw new Error("Image is not supported.")}function Q(...t){try{return K(...t)}catch{}return N(...t)}async function V(t){let e=Q(t);return await L(e)}async function Z(t){if(J(t))return a(0,0);let e=URL.createObjectURL(t);try{return await V(e)}finally{URL.revokeObjectURL(e)}}function _(t){return!t.length}async function tt(t){return _(t)?a(0,0):await V(t)}async function et(t){return await V(""+t)}async function nt(t){return t.isEmpty()?a(0,0):await et(t)}o.blank=function(t,e){return new this(a(t=s(t),e=s(e)))},o.filled=function(t,e,n){let r=this.blank(e,n);if(({sizeX:e,sizeY:n}=r),(t=d(t))&&e&&n){let{context:i}=r;i.save(),i.fillStyle=t,i.fillRect(0,0,e,n),i.restore()}return r},o.prototype.crop=function(t,e,n,r){let{canvas:i,sizeX:a,sizeY:o}=this;if(t=m(t),e=m(e),n=g(n,a),e<0&&(e+=o),t<0&&(t+=a),(r=g(r,o))<0&&(e+=r,r*=-1),n<0&&(t+=n,n*=-1),t||e||n!==a||r!==o){let s=this.constructor.blank(n,r);if(n&&r&&a&&o){let{context:n}=s;n.drawImage(i,-t,-e)}return s}return this},o.prototype.reframe=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;t=v(t,i),e=v(e,a),n=y(n),r=y(r);let o=(()=>{switch(n){case"start":return 0;case"end":return-t}return(i+t)/-2})(),s=(()=>{switch(r){case"start":return 0;case"end":return-e}return(a+e)/-2})();return this.crop(o,s,t,e)},o.from=function(t){if(this.is(t))return t;return new this(W(t))},o.fromExcept=(()=>{let t=!0;return function(...e){return t&&(console.warn("[DearImage] The function `.fromExcept` is deprecated. Please use `.from` instead."),t=!1),this.from.call(this,...e)}})(),o.drawed=function(t,e,n,r){let i,a,s,l,f=this.blank(e,n);if(({sizeX:e,sizeY:n}=f),t=A(t),(t=>{u(t)&&((t=>{u(t)?(i=t.x,a=t.y):i=a=t})(t.alignment),(t=>{u(t)?(s=t.x,l=t.y):s=l=t})(t.repeat))})(r),t&&e&&n){let{canvas:r}=o.filled(u.createPattern(t.canvas,s&&l?"repeat":s?"repeat-x":l?"repeat-y":"no-repeat"),c(e,t.sizeX),c(n,t.sizeY)).reframe(e,n,i,a),{context:u}=f;u.drawImage(r,0,0)}return f},o.isDearImage=o.is.bind(o);class rt{static is(t){return t instanceof this}static isString(t){try{return this.parse(t),!0}catch{return!1}}static parse(t){if(w(t)){let e=/^data:(.*?)(;base64)?,(.*)$/.exec(t);if(e){let n=e[1],r=e[2],i=e[3];return Object.assign(new this,{type:n,encoded:r,data:i,toString:()=>t})}}throw new Error("Invalid data URL.")}isEmpty(){return!this.data}}async function it(t){try{let e=rt.parse(t);return await nt(e)}catch{}return await V(t)}function at(t){let{URL:e}=globalThis;return!!e&&t instanceof e}async function ot(t){return w(t)?await it(t):at(t)?await et(t):rt.is(t)?await nt(t):$(t)?await tt(t):q(t)?await Z(t):O(t)?await L(t):W(t)}function st(t,...e){return function(...n){return t.call(this,...e,...n)}}function ct(t,e,n){let{canvas:r,sizeX:i,sizeY:a}=this;if(i&&a){let t=this.constructor.blank(i,a),{canvas:s}=o.drawed(e,i,a,n),{context:c}=t;return c.drawImage(r,0,0),c.drawImage(s,0,0),t}return this}function ut(t,e){let{canvas:n,sizeX:r,sizeY:i}=this;if(r&&i){let a=this.constructor.blank(r,i),{context:o}=a;return o.save(),o.translate(t?r:0,e?i:0),o.scale(t?-1:1,e?-1:1),o.drawImage(n,0,0),o.restore(),a}return this}function lt(t){return null!=t?t:1}function ft(t,e,n){let{sizeX:r,sizeY:i}=this;e=v(e,r),n=v(n,i);let a=[];if(e&&r){let t=e/r;a.push(t)}if(n&&i){let t=n/i;a.push(t)}if(a.length){let e=t(a);return this.scale(e)}return this}function ht(t){return null!=t?t%(2*Math.PI):0}o.loadFrom=async function(t){if(this.is(t))return t;return new this(await ot(t))},o.loadFromExcept=(()=>{let t=!0;return function(...e){return t&&(console.warn("[DearImage] The function `.loadFromExcept` is deprecated. Please use `.loadFrom` instead."),t=!1),this.loadFrom.call(this,...e)}})(),Object.assign(o.prototype,{drawBackground:st(ct,!1),drawForeground:st(ct,!0)}),o.prototype.drawCheckeredBackground=function(){return this},o.prototype.fillBackground=function(t){let{sizeX:e,sizeY:n}=this;return this.drawBackground(this.constructor.filled(t,e,n))},o.prototype.fillForeground=function(t){let{sizeX:e,sizeY:n}=this;return this.drawForeground(this.constructor.filled(t,e,n))},Object.assign(o.prototype,{flipX:st(ut,!0,!1),flipY:st(ut,!1,!0)}),o.prototype.toImageData=function(){let{context:t,sizeX:e,sizeY:n}=this;return t.getImageData(0,0,e,n)},o.prototype.isBlank=function(){let{sizeX:t,sizeY:e}=this;return!(t&&e&&this.toImageData().data.some((t=>t)))},o.prototype.resize=function(t,e){let{canvas:n,sizeX:r,sizeY:i}=this;if(t=v(t,r),e=v(e,i),t!==r||e!==i){let a=this.constructor.blank(t,e);if(t&&e&&r&&i){let o=t/r,s=e/i,{context:c}=a;c.save(),c.scale(o,s),c.drawImage(n,0,0),c.restore()}return a}return this},o.prototype.rescale=function(t,e){let{sizeX:n,sizeY:r}=this,i=n*(t=lt(t)),a=r*(e=lt(e));return this.resize(i,a)},o.prototype.scale=function(t){return this.rescale(t,t)},Object.assign(o.prototype,{scaleDownIn:st(ft,(t=>Math.min(Math.min(...t),1))),scaleDownOut:st(ft,(t=>Math.min(Math.max(...t),1))),scaleIn:st(ft,(t=>Math.min(...t))),scaleOut:st(ft,(t=>Math.max(...t))),scaleUpIn:st(ft,(t=>Math.max(Math.min(...t),1))),scaleUpOut:st(ft,(t=>Math.max(Math.max(...t),1)))}),o.prototype.reframeScaleIn=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;return t=v(t,i),e=v(e,a),this.scaleIn(t,e).reframe(t,e,n,r)},o.prototype.reframeScaleOut=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;return t=v(t,i),e=v(e,a),this.scaleOut(t,e).reframe(t,e,n,r)},o.prototype.resizeX=function(t,e){let{sizeX:n,sizeY:r}=this;if(t=v(t,n),e){let e=t/n;return this.scale(e)}return this.resize(t,r)},o.prototype.resizeY=function(t,e){let{sizeX:n,sizeY:r}=this;if(t=v(t,r),e){let e=t/r;return this.scale(e)}return this.resize(n,t)},o.prototype.rotate=function(t){let{canvas:e,sizeX:n,sizeY:r}=this;if((t=ht(t))&&n&&r){let i=Math.abs(Math.cos(t)),a=Math.abs(Math.sin(t)),o=Math.round(n*i+r*a),s=Math.round(n*a+r*i),c=this.constructor.blank(o,s),{context:u}=c;return u.save(),u.translate(o/2,s/2),u.rotate(t),u.drawImage(e,-n/2,-r/2),u.restore(),c}return this};var pt=Math.PI/2;o.prototype.rotateClockwise=function(){return this.rotate(pt)};var dt=-pt;function gt(t){let{length:e}=t,n=new Uint8Array(e);for(let r=0;r<e;r++)n[r]=t.charCodeAt(r);return n}function mt(t){try{if(w(t)){let{URL:e}=globalThis;if(e){let{document:n}=globalThis;return n?new e(t,n.location.origin):new e(t)}}}catch{}throw new Error("Invalid URL.")}function wt(t){try{return mt(t),!0}catch{return!1}}return o.prototype.rotateCounterClockwise=function(){return this.rotate(dt)},o.prototype.toBuffer=function(...t){let{canvas:e,sizeX:n,sizeY:r}=this;return n&&r?e.toBuffer(...t):Buffer.alloc(0)},o.prototype.saveToFileSystem=function(e,...n){return new Promise(((r,i)=>{let a=t("fs"),o=t("path"),s=this.toBuffer(...n);a.mkdir(o.dirname(e),{recursive:!0},(t=>{t?i(t):a.writeFile(e,s,(t=>{t?i(t):r()}))}))}))},o.prototype.toDataURL=function(...t){let{canvas:e}=this;return e.toDataURL(...t)},o.prototype.toBlob=function(...t){let{data:e,type:n}=rt.parse(this.toDataURL(...t)),r=gt(atob(e));return new Blob([r],{type:n})},o.prototype.toHTMLCanvasElement=function(){let{canvas:t,sizeX:e,sizeY:r}=this,i=n(e,r);return e&&r&&i.getContext("2d").drawImage(t,0,0),i},o.prototype.toHTMLImageElement=function(...t){return K(this.toDataURL(...t))},o.prototype.toOffscreenCanvas=function(){let{canvas:t,sizeX:e,sizeY:n}=this,i=r(e,n);return e&&n&&i.getContext("2d").drawImage(t,0,0),i},o.utils={},o.utils.isDataURL=function(t){return rt.isString(t)},o.utils.isURL=function(t){return at(t)||wt(t)},o}));

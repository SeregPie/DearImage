!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).DearImage=t()}(this,(function(){"use strict";class DearImage{constructor(e){this.context=e}get canvas(){return this.context.canvas}get sizeX(){return this.canvas.width}get sizeY(){return this.canvas.height}}function Canvas_createHTMLElement(){try{return document.createElement("canvas")}catch{}throw new Error("HTMLCanvasElement is not supported.")}function nativeRequire(id){return eval("require")(id)}function Canvas_createNode(){try{let{Canvas:e}=nativeRequire("canvas");return new e}catch(e){console.log(e)}throw new Error("Canvas is not supported.")}function Canvas_createOffscreen(){try{return new OffscreenCanvas}catch{}throw new Error("OffscreenCanvas is not supported.")}function Canvas_create(){try{return Canvas_createHTMLElement()}catch{}try{return Canvas_createOffscreen()}catch{}return Canvas_createNode()}function Number_prototype_isPositive(e){return e>0}function Number_isPositiveFinite(e){return Number.isFinite(e)&&Number_prototype_isPositive(e)}function Blob_is(e){let{Blob:t}=globalThis;return!!t&&e instanceof t}function Blob_prototype_isEmpty(e){return!e.size}function Buffer_is(e){let{Buffer:t}=globalThis;return!!t&&e instanceof t}function Buffer_prototype_isEmpty(e){return!e.length}function Canvas_isHTMLElement(e){let{HTMLCanvasElement:t}=globalThis;return!!t&&e instanceof t}function Canvas_isNode(e){try{let{Canvas:t}=nativeRequire("canvas");return e instanceof t}catch{}return!1}function Canvas_isOffscreen(e){let{OffscreenCanvas:t}=globalThis;return!!t&&e instanceof t}function Canvas_is(e){return Canvas_isHTMLElement(e)||Canvas_isOffscreen(e)||Canvas_isNode(e)}function is(e){return e instanceof this}function isString(e){return!!this.parse(e)}function String_is(e){return"string"==typeof e}DearImage.blank=function(e,t){e=Number_isPositiveFinite(e)?Math.round(e):0,t=Number_isPositiveFinite(t)?Math.round(t):0;let a=Canvas_create();return a.width=e,a.height=t,new this(a.getContext("2d"))},DearImage.is=function(e){return e instanceof this};var regex=/^data:(.*?)(;base64)?,(.*)$/;function parse(e){if(String_is(e)){let t=regex.exec(e);if(t){let a=t[1],i=t[3];return Object.assign(new this,{type:a,data:i,toString:()=>e})}}return!1}var classMembers={is:is,isString:isString,parse:parse};function isEmpty(){return!this.data}var classPrototypeMembers={isEmpty:isEmpty};let Class=class{},{prototype:prototype}=Class;function Image_createHTMLElement(){try{return new Image}catch{}throw new Error("HTMLImageElement is not supported.")}function Image_createNode(){try{let{Image:e}=nativeRequire("canvas");return new e}catch{}throw new Error("Image is not supported.")}function Image_create(){try{return Image_createHTMLElement()}catch{}return Image_createNode()}function Image_isHTMLElement(e){let{HTMLImageElement:t}=globalThis;return!!t&&e instanceof t}function Image_isNode(e){try{let{Image:t}=nativeRequire("canvas");return e instanceof t}catch{}return!1}function Image_is(e){return Image_isHTMLElement(e)||Image_isNode(e)}async function Image_prototype_load(e){if(!e.complete)try{await new Promise((t,a)=>{e.onload=t,e.onerror=a})}finally{e.onload=null,e.onerror=null}}function ImageData_isNode(e){try{let{ImageData:t}=nativeRequire("canvas");return e instanceof t}catch{}return!1}function ImageData_is(e){let{ImageData:t}=globalThis;return!!t&&e instanceof t||ImageData_isNode(e)}function URL_is(e){let{URL:t}=globalThis;return!!t&&e instanceof t}Object.assign(Class,classMembers),Object.assign(prototype,classPrototypeMembers);let DearImage_fromImageData=function(e){let t=this.blank(e.width,e.height);return t.sizeX&&t.sizeY&&t.context.putImageData(e,0,0),t},DearImage_fromCanvasImageSource=function(e,t,a){let i=this.blank(t,a);return i.sizeX&&i.sizeY&&i.context.drawImage(e,0,0),i},DearImage_fromCanvas=function(e){return DearImage_fromCanvasImageSource.call(this,e,e.width,e.height)},DearImage_fromImage=function(e){return DearImage_fromCanvasImageSource.call(this,e,e.naturalWidth,e.naturalHeight)},DearImage_fromDearImage=function(e){return DearImage_fromCanvas.call(this,e.canvas)},DearImage_from=function(e){if(DearImage.is(e))return DearImage_fromDearImage.call(this,e);if(ImageData_is(e))return DearImage_fromImageData.call(this,e);if(Canvas_is(e))return DearImage_fromCanvas.call(this,e);if(Image_is(e))return DearImage_fromImage.call(this,e);throw new Error},DearImage_loadFromImage=async function(e){return await Image_prototype_load(e),DearImage_fromImage.call(this,e)},DearImage_loadFromImageSource=async function(e){let t=Image_create();return t.src=e,DearImage_loadFromImage.call(this,t)},DearImage_loadFromBuffer=async function(e){return Buffer_prototype_isEmpty(e)?this.blank():DearImage_loadFromImageSource.call(this,e)},DearImage_loadFromBlob=async function(e){if(Blob_prototype_isEmpty(e))return this.blank();let t=URL.createObjectURL(e);try{return DearImage_loadFromImageSource.call(this,t)}finally{URL.revokeObjectURL(t)}},DearImage_loadFromDataURL=async function(e){return e.isEmpty()?this.blank():DearImage_loadFromImageSource.call(this,""+e)},DearImage_loadFromString=async function(e){{let t=Class.parse(e);if(t)return DearImage_loadFromDataURL.call(this,t)}return DearImage_loadFromImageSource.call(this,e)},DearImage_loadFromURL=async function(e){return DearImage_loadFromImageSource.call(this,""+e)},DearImage_loadFrom=async function(e){return String_is(e)?DearImage_loadFromString.call(this,e):URL_is(e)?DearImage_loadFromURL.call(this,e):Buffer_is(e)?DearImage_loadFromBuffer.call(this,e):Blob_is(e)?DearImage_loadFromBlob.call(this,e):Image_is(e)?DearImage_loadFromImage.call(this,e):DearImage_from.call(this,e)};function Object_is(e){if(e){let t=typeof e;return"object"===t||"function"===t}return!1}Object.assign(DearImage,{from:DearImage_from,loadFrom:DearImage_loadFrom}),DearImage.fromExcept=function(e){return this.is(e)?e:this.from(e)},DearImage.isDearImage=DearImage.is.bind(DearImage);var defaultFamily="sans-serif",defaultWeight="normal";function String_prototype_isEmpty(e){return!e}function String_prototype_isNonEmpty(e){return!String_prototype_isEmpty(e)}function String_isNonEmpty(e){return String_is(e)&&String_prototype_isNonEmpty(e)}function sanitizeFamily(e){return String_isNonEmpty(e)?e:defaultFamily}var validValues=new Set([defaultWeight,"italic","oblique"]);function sanitizeStyle(e){return String_is(e)&&(e=e.trim().toLowerCase(),validValues.has(e))?e:defaultWeight}var validValues$1=new Set([defaultWeight,"small-caps"]);function sanitizeVariant(e){return String_is(e)&&(e=e.trim().toLowerCase(),validValues$1.has(e))?e:defaultWeight}function Number_is(e){return"number"==typeof e&&!Number.isNaN(e)}function Number_prototype_isBetween(e,t,a,i,r){return(i?e>=t:e>t)&&(r?e<=a:e<a)}function Number_isBetween(e,...t){return Number_is(e)&&Number_prototype_isBetween(e,...t)}var validValues$2=new Set([defaultWeight,"bold"]);function sanitizeWeight(e){if(String_is(e)){if(e=e.trim().toLowerCase(),validValues$2.has(e))return e}else if(Number_isBetween(e,1,1e3,!0,!0))return e=Math.round(e);return defaultWeight}function from(e){let t=defaultFamily,a=defaultWeight,i=defaultWeight,r=defaultWeight;return String_is(e)?t=sanitizeFamily(e):Object_is(e)&&(t=sanitizeFamily(e.family),a=sanitizeStyle(e.style),i=sanitizeVariant(e.variant),r=sanitizeWeight(e.weight)),Object.assign(new this,{family:t,style:a,variant:i,weight:r})}function fromExcept(e){return this.is(e)?e:this.from(e)}function is$1(e){return e instanceof this}var classMembers$1={from:from,fromExcept:fromExcept,is:is$1};function CSS_font(e,t,a,i,r){return[a,i,r,t+"px",e].join(" ")}function Object_isNull(e){return null===e}function Object_isUndefined(e){return void 0===e}function Object_isNullish(e){return Object_isUndefined(e)||Object_isNull(e)}async function load(e){let{family:t,style:a,variant:i,weight:r}=this;if(Object_isNullish(e))try{await document.fonts.load(CSS_font(t,10,a,i,r))}catch{}else{try{await new FontFace(t,e,{style:a,variant:i,weight:r}).load()}catch{}try{let{registerFont:n}=nativeRequire("canvas");await n(e,{family:t,style:a,variant:i,weight:r})}catch{}}}var classPrototypeMembers$1={load:load};let Class$1=class{},{prototype:prototype$1}=Class$1;Object.assign(Class$1,classMembers$1),Class$1.default=Class$1.from(),Object.assign(prototype$1,classPrototypeMembers$1),DearImage.loadFontFace=async function(e,t){return Class$1.fromExcept(e).load(t)},DearImage.loadFromExcept=async function(e){return this.is(e)?e:this.loadFrom(e)};var defaultSize=10;function Number_prototype_isNegative(e){return e<0}function Number_prototype_isNonNegative(e){return!Number_prototype_isNegative(e)}function Number_isNonNegativeFinite(e){return Number.isFinite(e)&&Number_prototype_isNonNegative(e)}function sanitizeSize(e){return Number_isNonNegativeFinite(e)?e=Math.round(e):defaultSize}function from$1(e){let t=Class$1.default,a=defaultSize;Object_is(e)&&(t=Class$1.from(e),a=sanitizeSize(e.size));let{family:i,style:r,variant:n,weight:s}=t;return Object.assign(new this,{family:i,size:a,style:r,variant:n,weight:s})}function fromExcept$1(e){return this.is(e)?e:this.from(e)}function is$2(e){return e instanceof this}var classMembers$2={from:from$1,fromExcept:fromExcept$1,is:is$2};function toCSS(){let{family:e,size:t,style:a,variant:i,weight:r}=this;return CSS_font(e,t,a,i,r)}var classPrototypeMembers$2={toCSS:toCSS};let Class$2=class{},{prototype:prototype$2}=Class$2;function Function_prototype_bindPartial(e,...t){return function(...a){return e.call(this,...t,...a)}}Object.assign(Class$2,classMembers$2),Class$2.default=Class$2.from(),Object.assign(prototype$2,classPrototypeMembers$2),DearImage.measureText=function(e,t){e=Object_isNullish(e)?"":""+e;let{context:a}=this.blank();return a.font=Class$2.fromExcept(t).toCSS(),a.measureText(e)},DearImage.text=function(e,t){e=Object_isNullish(e)?"":""+e;let a="#000",i=Class$2.default,r=.28;Object_is(t)&&(String_isNonEmpty(t.fill)&&(a=t.fill),i=Class$2.fromExcept(t.font),Number_isNonNegativeFinite(t.padding)&&(r=t.padding)),r=Math.ceil(r*i.size);let n=this.blank(this.measureText(e,i).width+2*r,i.size+2*r),{context:s}=n;return s.save(),s.font=i.toCSS(),s.textBaseline="top",s.textAlign="left",s.fillStyle=a,s.fillText(e,r,r),s.restore(),n},DearImage.prototype.crop=function(e,t,a,i){if(Number.isFinite(e)?(e=Math.round(e))<0&&(e+=this.sizeX):e=0,Number.isFinite(t)?(t=Math.round(t))<0&&(t+=this.sizeY):t=0,Number.isFinite(a)?(a=Math.round(a))<0&&(e+=a,a*=-1):({sizeX:a}=this),Number.isFinite(i)?(i=Math.round(i))<0&&(t+=i,i*=-1):({sizeY:i}=this),e||t||a!==this.sizeX||i!==this.sizeY){let r=this.constructor.blank(a,i);return a&&i&&this.sizeX&&this.sizeY&&r.context.drawImage(this.canvas,-e,-t),r}return this};let f=function(e,t){let{sizeX:a,sizeY:i}=this;if(a&&i){let r=this.constructor.blank(a,i),{context:n}=r;return n.save(),n.translate(e?a:0,t?i:0),n.scale(e?-1:1,t?-1:1),n.drawImage(this.canvas,0,0),n.restore(),r}return this};Object.assign(DearImage.prototype,{flipX:Function_prototype_bindPartial(f,!0,!1),flipY:Function_prototype_bindPartial(f,!1,!0)}),DearImage.prototype.reframe=function(e,t,a,i){Number_isNonNegativeFinite(e)?e=Math.round(e):({sizeX:e}=this),Number_isNonNegativeFinite(t)?t=Math.round(t):({sizeY:t}=this);let r=(()=>{if(String_is(a))switch(a.trim().toLowerCase()){case"start":return 0;case"end":return-e}return(this.sizeX+e)/-2})(),n=(()=>{if(String_is(i))switch(i.trim().toLowerCase()){case"start":return 0;case"end":return-t}return(this.sizeY+t)/-2})();return this.crop(r,n,e,t)},DearImage.prototype.resize=function(e,t){if(Number_isNonNegativeFinite(e)?e=Math.round(e):({sizeX:e}=this),Number_isNonNegativeFinite(t)?t=Math.round(t):({sizeY:t}=this),e!==this.sizeX||t!==this.sizeY){let a=this.constructor.blank(e,t);if(e&&t&&this.sizeX&&this.sizeY){let i=e/this.sizeX,r=t/this.sizeY,{context:n}=a;n.save(),n.scale(i,r),n.drawImage(this.canvas,0,0),n.restore()}return a}return this},DearImage.prototype.rescale=function(e,t){let{sizeX:a,sizeY:i}=this;return Number_isNonNegativeFinite(e)&&(a*=e),Number_isNonNegativeFinite(t)&&(i*=t),this.resize(a,i)},DearImage.prototype.scale=function(e){return this.rescale(e,e)},DearImage.prototype.resizeX=function(e,t){return t?this.sizeX&&Number_isNonNegativeFinite(e)?(e=Math.round(e),this.scale(e/this.sizeX)):this:this.resize(e,this.sizeY)},DearImage.prototype.resizeY=function(e,t){return t?this.sizeY&&Number_isNonNegativeFinite(e)?(e=Math.round(e),this.scale(e/this.sizeY)):this:this.resize(this.sizeX,e)},DearImage.prototype.toBuffer=function(...e){return this.sizeX&&this.sizeY?this.canvas.toBuffer(...e):Buffer.alloc(0)},DearImage.prototype.saveToFileSystem=function(e,...t){return new Promise((a,i)=>{let r=nativeRequire("fs"),n=nativeRequire("path"),s=this.toBuffer(...t);r.mkdir(n.dirname(e),{recursive:!0},t=>{t?i(t):r.writeFile(e,s,e=>{e?i(e):a()})})})};let f$1=function(e,t,a){Number_isNonNegativeFinite(t)?t=Math.round(t):({sizeX:t}=this),Number_isNonNegativeFinite(a)?a=Math.round(a):({sizeY:a}=this);let i=[];if(t&&this.sizeX){let e=t/this.sizeX;i.push(e)}if(a&&this.sizeY){let e=a/this.sizeY;i.push(e)}if(i.length){let t=e(i);return this.scale(t)}return this};function String_prototype_toCharCode(e){let{length:t}=e,a=new Uint8Array(t);for(let i=0;i<t;i++)a[i]=e.charCodeAt(i);return a}function URL_parse(e){if(String_is(e)){let{URL:t}=globalThis;if(t){let{document:a}=globalThis,i=a&&a.location&&a.location.origin;try{return new t(e,i)}catch{}}}return!1}function URL_isString(e){return!!URL_parse(e)}return Object.assign(DearImage.prototype,{scaleDownIn:Function_prototype_bindPartial(f$1,e=>Math.min(Math.min(...e),1)),scaleDownOut:Function_prototype_bindPartial(f$1,e=>Math.min(Math.max(...e),1)),scaleIn:Function_prototype_bindPartial(f$1,e=>Math.min(...e)),scaleOut:Function_prototype_bindPartial(f$1,e=>Math.max(...e)),scaleUpIn:Function_prototype_bindPartial(f$1,e=>Math.max(Math.min(...e),1)),scaleUpOut:Function_prototype_bindPartial(f$1,e=>Math.max(Math.max(...e),1))}),DearImage.prototype.toDataURL=function(...e){return this.canvas.toDataURL(...e)},DearImage.prototype.toBlob=function(...e){let{data:t,type:a}=Class.parse(this.toDataURL(...e)),i=String_prototype_toCharCode(atob(t));return new Blob([i],{type:a})},DearImage.prototype.toHTMLCanvasElement=function(){let e=Canvas_createHTMLElement(),{sizeX:t,sizeY:a}=this;return e.width=t,e.height=a,t&&a&&e.getContext("2d").drawImage(this.canvas,0,0),e},DearImage.prototype.toHTMLImageElement=function(...e){let t=Image_createHTMLElement();return t.src=this.toDataURL(...e),t},DearImage.prototype.toImageData=function(){return this.context.getImageData(0,0,this.sizeX,this.sizeY)},DearImage.prototype.toOffscreenCanvas=function(){let e=Canvas_createOffscreen(),{sizeX:t,sizeY:a}=this;return e.width=t,e.height=a,t&&a&&e.getContext("2d").drawImage(this.canvas,0,0),e},DearImage.utils={},DearImage.utils.isDataURL=function(e){return Class.is(e)||Class.isString(e)},DearImage.utils.isURL=function(e){return URL_is(e)||URL_isString(e)},DearImage}));

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).DearImage=e()}(this,(function(){"use strict";function t(t,e){try{return Object.assign(document.createElement("canvas"),{width:t,height:e})}catch{}throw new Error("HTMLCanvasElement is not supported.")}function e(t,e){try{return new OffscreenCanvas(t,e)}catch{}throw new Error("OffscreenCanvas is not supported.")}function n(...n){try{return t(...n)}catch{}try{return e(...n)}catch{}return function(t,e){try{let{Canvas:n}=require("canvas");return new n(t,e)}catch{}throw new Error("Canvas is not supported.")}(...n)}function r(...t){return n(...t).getContext("2d")}class i{static is(t){return t instanceof this}constructor(t){this.context=t}get canvas(){return this.context.canvas}get sizeX(){return this.canvas.width}get sizeY(){return this.canvas.height}}function a(t){return Number.isFinite(t)&&!function(t){return t<0}(t)}function s(t){return"string"==typeof t}function o(t,e){if(null!=t)return s(t)&&(t=Number(t)),a(t)?Math.round(t):e}function u(t){return o(t,0)}function c(t,e){return Math.ceil(t/e)*e}function l(t){let{CanvasGradient:e}=globalThis;return!!e&&t instanceof e||function(t){try{let{CanvasGradient:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function f(t){let{CanvasPattern:e}=globalThis;return!!e&&t instanceof e||function(t){try{let{CanvasPattern:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function h(t,e){return null!=t?l(t)||f(t)?t:function(t,e){if(null!=t&&s(t)){let e=r(0,0);{let n=e.fillStyle="#000";if(e.fillStyle=t,e.fillStyle!==n)return e.fillStyle}{let n=e.fillStyle="#fff";if(e.fillStyle=t,e.fillStyle!==n)return e.fillStyle}}return e}(t,e):e}function d(t,e){if(null!=t)return s(t)&&(t=Number(t)),Number.isFinite(t)?Math.round(t):e}function y(t){return d(t,0)}function g(t){if(null!=t&&s(t))return t.trim().toLowerCase()}function p(t){return function(t){let{HTMLCanvasElement:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){let{OffscreenCanvas:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){try{let{Canvas:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function m(t,e,n){let i=r(e,n);return e&&n&&i.drawImage(t,0,0),i}function w(t){return m(t,t.width,t.height)}function v({canvas:t}){return w(t)}async function z(t){return await async function(t){if(!t.complete)try{await new Promise(((e,n)=>{t.onload=e,t.onerror=n}))}finally{t.onload=null,t.onerror=null}}(t),function(t){return m(t,t.naturalWidth,t.naturalHeight)}(t)}function b(t){return function(t){let{HTMLImageElement:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){try{let{Image:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function x(t){let{ImageData:e}=globalThis;return!!e&&t instanceof e||function(t){try{let{ImageData:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function I(t){let{CanvasRenderingContext2D:e}=globalThis;return!!e&&t instanceof e||function(t){try{let{CanvasRenderingContext2D:e}=require("canvas");return t instanceof e}catch{}return!1}(t)}function X(t){return I(t)||function(t){let{WebGL2RenderingContext:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){let{WebGLRenderingContext:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){let{ImageBitmapRenderingContext:e}=globalThis;return!!e&&t instanceof e}(t)||function(t){let{OffscreenCanvasRenderingContext2D:e}=globalThis;return!!e&&t instanceof e}(t)}function Y(t){if(i.is(t))return v(t);if(x(t))return function(t){let{height:e,width:n}=t,i=r(n,e);return n&&e&&i.putImageData(t,0,0),i}(t);if(p(t))return w(t);if(X(t))return v(t);if(b(t))return z(t);throw new Error("Failed to create a CanvasRenderingContext2D instance from the given value.")}function k(t){if(t){let e=typeof t;return"object"===e||"function"===e}return!1}i.blank=function(t,e){return new this(r(t=u(t),e=u(e)))},i.fill=function(t,e,n){t=h(t);let r=this.blank(e,n);if(({sizeX:e,sizeY:n}=r),t&&e&&n){let{context:i}=r;i.save(),i.fillStyle=t,i.fillRect(0,0,e,n),i.restore()}return r},i.prototype.crop=function(t,e,n,r){let{canvas:i,sizeX:a,sizeY:s}=this;if(t=y(t),e=y(e),n=d(n,a),e<0&&(e+=s),t<0&&(t+=a),(r=d(r,s))<0&&(e+=r,r*=-1),n<0&&(t+=n,n*=-1),t||e||n!==a||r!==s){let o=this.constructor.blank(n,r);if(n&&r&&a&&s){let{context:n}=o;n.drawImage(i,-t,-e)}return o}return this},i.prototype.reframe=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;t=o(t,i),e=o(e,a),n=g(n),r=g(r);let s=-(()=>{switch(n){case"start":return 0;case"end":return t}return(i+t)/2})(),u=-(()=>{switch(r){case"start":return 0;case"end":return e}return(a+e)/2})();return this.crop(s,u,t,e)},i.from=function(t){if(this.is(t))return t;return new this(Y(t))},i.draw=function(t,e,n,r){t=function(t){if(null!=t)try{let e=i.from(t);if(e.sizeX&&e.sizeY)return e}catch{}}(t);let{alignmentX:a,alignmentY:s,repeatX:o,repeatY:u}=function(t){let e,n,r,i;return k(t)&&((t=>{k(t)?(e=t.x,n=t.y):e=n=t})(t.alignment),(t=>{k(t)?(r=t.x,i=t.y):r=i=t})(t.repeat)),{alignmentX:e,alignmentY:n,repeatX:r,repeatY:i}}(r),l=this.blank(e,n);if(({sizeX:e,sizeY:n}=l),t&&e&&n){let{context:r}=l,{canvas:f}=i.fill(r.createPattern(t.canvas,o&&u?"repeat":o?"repeat-x":u?"repeat-y":"no-repeat"),c(e,t.sizeX),c(n,t.sizeY)).reframe(e,n,a,s);r.drawImage(f,0,0)}return l},i.flexLayout=function(t,...e){switch(t){case"x":return this.flexLayoutX(...e);case"y":return this.flexLayoutY(...e)}},i.flexLayoutX=function(t,{alignItems:e="center",gap:n=0}={}){let r=t.map((({sizeX:t})=>t)).reduce(((t,e)=>t+e+n)),i=t.map((({sizeY:t})=>t)).reduce(((t,e)=>Math.max(t,e))),a=this.blank(r,i),{context:s}=a,o=0;return t.forEach((t=>{let r;switch(e){case"start":r=0;break;case"center":r=Math.round((i-t.sizeY)/2);break;case"end":r=i-t.sizeY}s.drawImage(t.canvas,o,r),o+=t.sizeX+n})),a},i.flexLayoutY=function(t,{alignItems:e="center",gap:n=0}={}){let r=t.map((({sizeY:t})=>t)).reduce(((t,e)=>t+e+n)),i=t.map((({sizeX:t})=>t)).reduce(((t,e)=>Math.max(t,e))),a=this.blank(i,r),{context:s}=a,o=0;return t.forEach((t=>{let r;switch(e){case"start":r=0;break;case"center":r=Math.round((i-t.sizeX)/2);break;case"end":r=i-t.sizeX}s.drawImage(t.canvas,r,o),o+=t.sizeY+n})),a},i.isDearImage=i.is.bind(i);class C{static is(t){return t instanceof this}constructor(t,e,{style:n,variant:i,weight:a}={}){let s;{let r=[`${e}px`,t];void 0!==a&&r.unshift(a),void 0!==i&&r.unshift(i),void 0!==n&&r.unshift(n),s=r.join(" ")}Object.assign(this,{family:t,size:e,style:n,variant:i,weight:a,measureText(t){let e=r(0,0);return e.font=s,e.measureText(t)},toString:()=>s})}}class M{static is(t){return t instanceof this}constructor(t,{style:e,variant:n,weight:r}={}){Object.assign(this,{family:t,style:e,variant:n,weight:r,async load(i){if(i){try{return void await new FontFace(t,i,{style:e,variant:n,weight:r}).load()}catch{}try{let{registerFont:a}=require("canvas");return void await a(i,{family:t,style:e,variant:n,weight:r})}catch{}}try{let i=new C(t,1,{style:e,variant:n,weight:r});return void await document.fonts.load(`${i}`)}catch{}}})}}var T="sans-serif";function L(t){return null!=t?t:"sans-serif"}function O(t){try{return Object.assign(new Image,{src:t})}catch{}throw new Error("HTMLImageElement is not supported.")}function R(...t){try{return O(...t)}catch{}return function(t){try{let{Image:e}=require("canvas");return Object.assign(new e,{src:t})}catch{}throw new Error("Image is not supported.")}(...t)}async function S(t){let e=R(t);return await z(e)}async function E(t){return await S(`${t}`)}async function D(t){return t.isEmpty()?r(0,0):await E(t)}i.loadFontFace=async function(t,e){t=function(t){if(M.is(t))return t;let e,n,r,i;return k(t)?(({family:e,style:n,variant:r,weight:i}=t),e=L(e),n=n,r=r,i=i):e=L(t),({family:e=T}={family:e}),new M(e,{style:n,variant:r,weight:i})}(t),e=e,await t.load(e)};class U{static is(t){return t instanceof this}static isValid(t){try{return this.parse(t),!0}catch{return!1}}static parse(t){if(s(t)){let e=/^data:(.*?)(;base64)?,(.*)$/.exec(t);if(e){let n=e[1],r=e[2],i=e[3],a=!i;return Object.assign(new this,{type:n,encoded:r,data:i,isEmpty:()=>a,toString:()=>t})}}throw new Error("Invalid data URL.")}}function j(t){let{URL:e}=globalThis;return!!e&&t instanceof e}async function B(t){return s(t)?await async function(t){try{let e=U.parse(t);return await D(e)}catch{}return await S(t)}(t):j(t)?await E(t):U.is(t)?await D(t):function(t){let{Buffer:e}=globalThis;return!!e&&t instanceof e}(t)?await async function(t){return t.length?await S(t):r(0,0)}(t):function(t){let{Blob:e}=globalThis;return!!e&&t instanceof e}(t)?await async function(t){if(!t.size)return r(0,0);let e=URL.createObjectURL(t);try{return await S(e)}finally{URL.revokeObjectURL(e)}}(t):b(t)?await z(t):Y(t)}i.loadFrom=async function(t){if(this.is(t))return t;return new this(await B(t))};var F=16;function q(t,e){if(null!=t)return s(t)&&(t=Number(t)),a(t)?t:e}function G(t){if(C.is(t))return t;let e,n,r,i,a;return k(t)&&(({family:e,size:n,style:r,variant:i,weight:a}=t),e=L(e),n=q(n),r=r,i=i,a=a),({family:e=T,size:n=F}={family:e,size:n}),new C(e,n,{style:r,variant:i,weight:a})}function W(t){return null==t?"":String(t)}i.measureText=function(t,e){return t=W(t),(e=G(e)).measureText(t)};var H=1/4,N=.5,P="#000",$=0;function A(t,...e){return function(...n){return t.call(this,...e,...n)}}function V(t,e,n){let{canvas:r,sizeX:a,sizeY:s}=this;if(a&&s){let o=this.constructor.blank(a,s),{canvas:u}=i.draw(e,a,s,n),{context:c}=o;return t?(c.drawImage(r,0,0),c.drawImage(u,0,0)):(c.drawImage(u,0,0),c.drawImage(r,0,0)),o}return this}function J(t,e){let{canvas:n,sizeX:r,sizeY:i}=this;if(r&&i){let a=this.constructor.blank(r,i),{context:s}=a;return s.save(),s.translate(t?r:0,e?i:0),s.scale(t?-1:1,e?-1:1),s.drawImage(n,0,0),s.restore(),a}return this}function K(t){return q(t,1)}function Q(t,e,n){let{sizeX:r,sizeY:i}=this;e=o(e,r),n=o(n,i);let a=[];if(e&&r){let t=e/r;a.push(t)}if(n&&i){let t=n/i;a.push(t)}if(a.length){let e=t(a);return this.scale(e)}return this}function Z(t){return function(t,e){if(null!=t)return s(t)&&(t=Number(t)),Number.isFinite(t)?t:e}(t,0)%(2*Math.PI)}i.text=function(t,e){t=W(t);let{alignment:n,font:r,lineGap:i,padding:a,strokeStyle:s,strokeWidth:o,style:u}=function(t){let e,n,r,i,a,s,o;return k(t)&&(({alignment:e,font:n,lineGap:r,padding:i,style:o}=t),e=g(e),r=q(r),i=q(i),o=h(o),(t=>{k(t)&&(({style:a,width:s}=t),a=h(a),s=q(s))})(t.stroke)),n=G(n),({lineGap:r=H,padding:i=N,strokeStyle:a=P,strokeWidth:s=$,style:o=P}={lineGap:r,padding:i,strokeStyle:a,strokeWidth:s,style:o}),{alignment:e,font:n,lineGap:r,padding:i,strokeStyle:a,strokeWidth:s,style:o}}(e),{size:c}=r;a*=c,i*=c,o*=c;let l,f=t?t.split("\n"):[],d=f.length,y=c+i,p=d?Math.max(...f.map((t=>r.measureText(t).width))):0,m=a+o/2,w=p+2*m,v=(d?c+y*(d-1):0)+2*m,z=m+c/2,b=this.blank(w,v);({sizeX:w,sizeY:v}=b);let{context:x}=b;return x.save(),Object.assign(x,{fillStyle:u,font:`${r}`,lineWidth:o,miterLimit:1,strokeStyle:s,textAlign:(()=>{switch(n){case"start":return l=m,"left";case"end":return l=w-m,"right"}return l=w/2,"center"})(),textBaseline:"middle"}),f.forEach((t=>{x.fillText(t,l,z),o&&x.strokeText(t,l,z),z+=y})),x.restore(),b},Object.assign(i.prototype,{drawBackground:A(V,!1),drawForeground:A(V,!0)}),i.prototype.drawCheckeredBackground=function(){return this},i.prototype.fillBackground=function(t){let{sizeX:e,sizeY:n}=this;return this.drawBackground(this.constructor.fill(t,e,n))},i.prototype.fillForeground=function(t){let{sizeX:e,sizeY:n}=this;return this.drawForeground(this.constructor.fill(t,e,n))},Object.assign(i.prototype,{flipX:A(J,!0,!1),flipY:A(J,!1,!0)}),i.prototype.toImageData=function(){let{context:t,sizeX:e,sizeY:n}=this;return t.getImageData(0,0,e,n)},i.prototype.isBlank=function(){let{sizeX:t,sizeY:e}=this;return!(t&&e&&this.toImageData().data.some((t=>t)))},i.prototype.resize=function(t,e){let{canvas:n,sizeX:r,sizeY:i}=this;if(t=o(t,r),e=o(e,i),t!==r||e!==i){let a=this.constructor.blank(t,e);if(t&&e&&r&&i){let s=t/r,o=e/i,{context:u}=a;u.save(),u.scale(s,o),u.drawImage(n,0,0),u.restore()}return a}return this},i.prototype.rescale=function(t,e){let{sizeX:n,sizeY:r}=this;t=K(t),e=K(e);let i=Math.round(n*t),a=Math.round(r*e);return this.resize(i,a)},i.prototype.scale=function(t){return this.rescale(t,t)},Object.assign(i.prototype,{scaleDownIn:A(Q,(t=>Math.min(Math.min(...t),1))),scaleDownOut:A(Q,(t=>Math.min(Math.max(...t),1))),scaleIn:A(Q,(t=>Math.min(...t))),scaleOut:A(Q,(t=>Math.max(...t))),scaleUpIn:A(Q,(t=>Math.max(Math.min(...t),1))),scaleUpOut:A(Q,(t=>Math.max(Math.max(...t),1)))}),i.prototype.reframeScaleIn=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;return t=o(t,i),e=o(e,a),this.scaleIn(t,e).reframe(t,e,n,r)},i.prototype.reframeScaleOut=function(t,e,n,r){let{sizeX:i,sizeY:a}=this;return t=o(t,i),e=o(e,a),this.scaleOut(t,e).reframe(t,e,n,r)},i.prototype.resizeX=function(t,e){let{sizeX:n,sizeY:r}=this;if(t=o(t,n),e){if(n){let e=t/n;return this.scale(e)}return this}return this.resize(t,r)},i.prototype.resizeY=function(t,e){let{sizeX:n,sizeY:r}=this;if(t=o(t,r),e){if(r){let e=t/r;return this.scale(e)}return this}return this.resize(n,t)},i.prototype.rotate=function(t){let{canvas:e,sizeX:n,sizeY:r}=this;if((t=Z(t))&&n&&r){let i=Math.abs(Math.cos(t)),a=Math.abs(Math.sin(t)),s=Math.round(n*i+r*a),o=Math.round(n*a+r*i),u=this.constructor.blank(s,o),{context:c}=u;return c.save(),c.translate(s/2,o/2),c.rotate(t),c.drawImage(e,-n/2,-r/2),c.restore(),u}return this};var _=Math.PI/2;i.prototype.rotateClockwise=function(){return this.rotate(_)};var tt=-_;function et(t){try{return function(t){try{if(s(t)){let{URL:e}=globalThis;if(e){let{document:n}=globalThis;return n?new e(t,n.location.origin):new e(t)}}}catch{}throw new Error("Invalid URL.")}(t),!0}catch{return!1}}return i.prototype.rotateCounterClockwise=function(){return this.rotate(tt)},i.prototype.toBuffer=function(...t){let{canvas:e,sizeX:n,sizeY:r}=this;return n&&r?e.toBuffer(...t):Buffer.alloc(0)},i.prototype.saveToFileSystem=function(t,...e){return new Promise(((n,r)=>{let i=require("fs"),a=require("path"),s=this.toBuffer(...e);i.mkdir(a.dirname(t),{recursive:!0},(e=>{e?r(e):i.writeFile(t,s,(t=>{t?r(t):n()}))}))}))},i.prototype.toDataURL=function(...t){let{canvas:e}=this;return e.toDataURL(...t)},i.prototype.toBlob=function(...t){let{data:e,type:n}=U.parse(this.toDataURL(...t)),r=function(t){let{length:e}=t,n=new Uint8Array(e);for(let r=0;r<e;r++)n[r]=t.charCodeAt(r);return n}(atob(e));return new Blob([r],{type:n})},i.prototype.toHTMLCanvasElement=function(){let{canvas:e,sizeX:n,sizeY:r}=this,i=t(n,r);return n&&r&&i.getContext("2d").drawImage(e,0,0),i},i.prototype.toHTMLImageElement=function(...t){return O(this.toDataURL(...t))},i.prototype.toOffscreenCanvas=function(){let{canvas:t,sizeX:n,sizeY:r}=this,i=e(n,r);return n&&r&&i.getContext("2d").drawImage(t,0,0),i},i.utils={},i.utils.isDataURL=function(t){return U.isValid(t)},i.utils.isURL=function(t){return j(t)||et(t)},i}));

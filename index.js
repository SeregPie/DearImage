!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).DearImage=n()}(this,(function(){"use strict";function t(t){return eval("require")(t)}function n(n,e){try{let{Canvas:r}=t("canvas");return new r(n,e)}catch{}throw new Error("Canvas is not supported.")}function e(t,n){try{return Object.assign(document.createElement("canvas"),{width:t,height:n})}catch{}throw new Error("HTMLCanvasElement is not supported.")}function r(t,n){try{return new OffscreenCanvas(t,n)}catch{}throw new Error("OffscreenCanvas is not supported.")}function i(...t){try{return e(...t)}catch{}try{return r(...t)}catch{}return n(...t)}function a(...t){return i(...t).getContext("2d")}class o{static is(t){return t instanceof this}constructor(t){this.context=t}get canvas(){return this.context.canvas}get sizeX(){return this.canvas.width}get sizeY(){return this.canvas.height}}function s(t){return t<0}function u(t){return!s(t)}function c(t){return Number.isFinite(t)&&u(t)}function l(t){if(c(t=Number(t)))return Math.round(t)}function f(n){try{let{CanvasGradient:e}=t("canvas");return n instanceof e}catch{}return!1}function h(t){let{CanvasGradient:n}=globalThis;return!!n&&t instanceof n||f(t)}function p(n){try{let{CanvasPattern:e}=t("canvas");return n instanceof e}catch{}return!1}function d(t){let{CanvasPattern:n}=globalThis;return!!n&&t instanceof n||p(t)}function g(t){let n=a(0,0),e=n.createLinearGradient(0,0,0,0);if(n.fillStyle=e,n.fillStyle=t,n.fillStyle!==e)return n.fillStyle}function y(t){return g(String(t))}function w(t){return h(t)||d(t)?t:y(t)}function m(n){try{let{Canvas:e}=t("canvas");return n instanceof e}catch{}return!1}function b(t){let{HTMLCanvasElement:n}=globalThis;return!!n&&t instanceof n}function v(t){let{OffscreenCanvas:n}=globalThis;return!!n&&t instanceof n}function z(t){return b(t)||v(t)||m(t)}function I(t,n,e){let r=a(n,e);return n&&e&&r.drawImage(t,0,0),r}function C(t){return I(t,t.width,t.height)}function x({canvas:t}){return C(t)}function L(t){return I(t,t.naturalWidth,t.naturalHeight)}async function M(t){if(!t.complete)try{await new Promise((n,e)=>{t.onload=n,t.onerror=e})}finally{t.onload=null,t.onerror=null}}async function T(t){return await M(t),L(t)}function k(t){let{height:n,width:e}=t,r=a(e,n);return e&&n&&r.putImageData(t,0,0),r}function X(t){let{HTMLImageElement:n}=globalThis;return!!n&&t instanceof n}function Y(n){try{let{Image:e}=t("canvas");return n instanceof e}catch{}return!1}function R(t){return X(t)||Y(t)}function O(n){try{let{ImageData:e}=t("canvas");return n instanceof e}catch{}return!1}function D(t){let{ImageData:n}=globalThis;return!!n&&t instanceof n||O(t)}function E(n){try{let{CanvasRenderingContext2D:e}=t("canvas");return n instanceof e}catch{}return!1}function U(t){let{CanvasRenderingContext2D:n}=globalThis;return!!n&&t instanceof n||E(t)}function B(t){let{ImageBitmapRenderingContext:n}=globalThis;return!!n&&t instanceof n}function j(t){let{WebGL2RenderingContext:n}=globalThis;return!!n&&t instanceof n}function S(t){let{WebGLRenderingContext:n}=globalThis;return!!n&&t instanceof n}function F(t){return U(t)||j(t)||S(t)||B(t)}function H(t){if(o.is(t))return x(t);if(D(t))return k(t);if(z(t))return C(t);if(F(t))return x(t);if(R(t))return T(t);throw new Error("Failed to create a CanvasRenderingContext2D instance from the given value.")}function N(t){let{Blob:n}=globalThis;return!!n&&t instanceof n}function P(t){let{Buffer:n}=globalThis;return!!n&&t instanceof n}function G(t){return!t.size}function W(t){try{return Object.assign(new Image,{src:t})}catch{}throw new Error("HTMLImageElement is not supported.")}function A(n){try{let{Image:e}=t("canvas");return Object.assign(new e,{src:n})}catch{}throw new Error("Image is not supported.")}function q(...t){try{return W(...t)}catch{}return A(...t)}async function $(t){let n=q(t);return await T(n)}async function J(t){if(G(t))return a(0,0);let n=URL.createObjectURL(t);try{return await $(n)}finally{URL.revokeObjectURL(n)}}function K(t){return!t.length}async function Q(t){return K(t)?a(0,0):await $(t)}async function V(t){return await $(""+t)}async function Z(t){return t.isEmpty()?a(0,0):await V(t)}o.blank=function(t,n){return[t=0,n=0]=[l(t),l(n)],new this(a(t,n))},o.drawed=function(){return this.blank()},o.filled=function(t,n,e){t=w(t);let r=this.blank(n,e);if(({sizeX:n,sizeY:e}=r),t&&n&&e){let{context:i}=r;i.save(),i.fillStyle=t,i.fillRect(0,0,n,e),i.restore()}return r},o.flexLayout=function(){return this.blank()},o.from=function(t){if(this.is(t))return t;return new this(H(t))},o.gridLayout=function(){return this.blank()},o.isDearImage=o.is.bind(o),o.lineLayout=function(){return this.blank()},o.text=function(){return this.blank()};class _{}function tt(t){return t instanceof this}function nt(t){try{return this.parse(t),!0}catch{return!1}}function et(t){return"string"==typeof t}var rt=/^data:(.*?)(;base64)?,(.*)$/;function it(t){if(et(t)){let n=rt.exec(t);if(n){let e=n[1],r=n[2],i=n[3];return Object.assign(new this,{type:e,encoded:r,data:i,toString:()=>t})}}throw new Error("Invalid data URL.")}var at={is:tt,isString:nt,parse:it};function ot(){return!this.data}var st={isEmpty:ot};let{prototype:ut}=_;async function ct(t){try{let n=_.parse(t);return await Z(n)}catch{}return await $(t)}function lt(t){let{URL:n}=globalThis;return!!n&&t instanceof n}async function ft(t){return et(t)?await ct(t):lt(t)?await V(t):_.is(t)?await Z(t):P(t)?await Q(t):N(t)?await J(t):R(t)?await T(t):H(t)}function ht(t){if(t=Number(t),Number.isFinite(t))return Math.round(t)}function pt(t,...n){return function(...e){return t.call(this,...n,...e)}}function dt(t,n,e){let{canvas:r,sizeX:i,sizeY:a}=this;if(i&&a){let t=this.constructor.blank(i,a),{canvas:s}=o.drawed(n,i,a,e),{context:u}=t;return u.drawImage(r,0,0),u.drawImage(s,0,0),t}return this}function gt(t,n){let{canvas:e,sizeX:r,sizeY:i}=this;if(r&&i){let a=this.constructor.blank(r,i),{context:o}=a;return o.save(),o.translate(t?r:0,n?i:0),o.scale(t?-1:1,n?-1:1),o.drawImage(e,0,0),o.restore(),a}return this}function yt(t){if(et(t))return t.trim().toLowerCase()}function wt(t){if(c(t=Number(t)))return t}function mt(t,n,e){let{sizeX:r,sizeY:i}=this;[n=r,e=i]=[l(n),l(e)];let a=[];if(n&&r){let t=n/r;a.push(t)}if(e&&i){let t=e/i;a.push(t)}if(a.length){let n=t(a);return this.scale(n)}return this}function bt(t){if(t=Number(t),Number.isFinite(t))return t%(2*Math.PI)}Object.assign(_,at),Object.assign(ut,st),o.loadFrom=async function(t){if(this.is(t))return t;return new this(await ft(t))},o.text=function(){return this.blank()},o.prototype.crop=function(t,n,e,r){let{canvas:i,sizeX:a,sizeY:o}=this;if([e=a,r=o,t=0,n=0]=[ht(e),ht(r),ht(t),ht(n)],n<0&&(n+=o),t<0&&(t+=a),r<0&&(n+=r,r*=-1),e<0&&(t+=e,e*=-1),t||n||e!==a||r!==o){let s=this.constructor.blank(e,r);if(e&&r&&a&&o){let{context:e}=s;e.drawImage(i,-t,-n)}return s}return this},Object.assign(o.prototype,{drawBackground:pt(dt,!1),drawForeground:pt(dt,!0)}),o.prototype.drawCheckeredBackground=function(){return this},o.prototype.fillBackground=function(t){let{sizeX:n,sizeY:e}=this;return this.drawBackground(this.constructor.filled(t,n,e))},o.prototype.fillForeground=function(t){let{sizeX:n,sizeY:e}=this;return this.drawForeground(this.constructor.filled(t,n,e))},Object.assign(o.prototype,{flipX:pt(gt,!0,!1),flipY:pt(gt,!1,!0)}),o.prototype.toImageData=function(){let{context:t,sizeX:n,sizeY:e}=this;return t.getImageData(0,0,n,e)},o.prototype.isBlank=function(){let{sizeX:t,sizeY:n}=this;return!(t&&n&&this.toImageData().data.some(t=>t))},o.prototype.reframe=function(t,n,e,r){let{sizeX:i,sizeY:a}=this;[e,r,t=i,n=a]=[yt(e),yt(r),l(t),l(n)];let o=(()=>{switch(e){case"start":return 0;case"end":return-t}return(i+t)/-2})(),s=(()=>{switch(r){case"start":return 0;case"end":return-n}return(a+n)/-2})();return this.crop(o,s,t,n)},o.prototype.resize=function(t,n){let{canvas:e,sizeX:r,sizeY:i}=this;if([t=r,n=i]=[l(t),l(n)],t!==r||n!==i){let a=this.constructor.blank(t,n);if(t&&n&&r&&i){let o=t/r,s=n/i,{context:u}=a;u.save(),u.scale(o,s),u.drawImage(e,0,0),u.restore()}return a}return this},o.prototype.rescale=function(t,n){let{sizeX:e,sizeY:r}=this;[t=1,n=1]=[wt(t),wt(n)];let i=e*t,a=r*n;return this.resize(i,a)},o.prototype.scale=function(t){return this.rescale(t,t)},Object.assign(o.prototype,{scaleDownIn:pt(mt,t=>Math.min(Math.min(...t),1)),scaleDownOut:pt(mt,t=>Math.min(Math.max(...t),1)),scaleIn:pt(mt,t=>Math.min(...t)),scaleOut:pt(mt,t=>Math.max(...t)),scaleUpIn:pt(mt,t=>Math.max(Math.min(...t),1)),scaleUpOut:pt(mt,t=>Math.max(Math.max(...t),1))}),o.prototype.reframeScaleIn=function(t,n,e,r){let{sizeX:i,sizeY:a}=this;return[t=i,n=a]=[l(t),l(n)],this.scaleIn(t,n).reframe(t,n,e,r)},o.prototype.reframeScaleOut=function(t,n,e,r){let{sizeX:i,sizeY:a}=this;return[t=i,n=a]=[l(t),l(n)],this.scaleOut(t,n).reframe(t,n,e,r)},o.prototype.resizeX=function(t,n){let{sizeX:e,sizeY:r}=this;if([t=e]=[l(t)],n){let n=t/e;return this.scale(n)}return this.resize(t,r)},o.prototype.resizeY=function(t,n){let{sizeX:e,sizeY:r}=this;if([t=r]=[l(t)],n){let n=t/r;return this.scale(n)}return this.resize(e,t)},o.prototype.rotate=function(t){let{canvas:n,sizeX:e,sizeY:r}=this;if([t=0]=[bt(t)],t&&e&&r){let i=Math.abs(Math.cos(t)),a=Math.abs(Math.sin(t)),o=Math.round(e*i+r*a),s=Math.round(e*a+r*i),u=this.constructor.blank(o,s),{context:c}=u;return c.save(),c.translate(o/2,s/2),c.rotate(t),c.drawImage(n,-e/2,-r/2),c.restore(),u}return this};var vt=Math.PI/2;o.prototype.rotateClockwise=function(){return this.rotate(vt)};var zt=-vt;function It(t){let{length:n}=t,e=new Uint8Array(n);for(let r=0;r<n;r++)e[r]=t.charCodeAt(r);return e}function Ct(t){try{if(et(t)){let{URL:n}=globalThis;if(n){let{document:e}=globalThis;return e?new n(t,e.location.origin):new n(t)}}}catch{}throw new Error("Invalid URL.")}function xt(t){try{return Ct(t),!0}catch{return!1}}return o.prototype.rotateCounterClockwise=function(){return this.rotate(zt)},o.prototype.toBuffer=function(...t){let{canvas:n,sizeX:e,sizeY:r}=this;return e&&r?n.toBuffer(...t):Buffer.alloc(0)},o.prototype.saveToFileSystem=function(n,...e){return new Promise((r,i)=>{let a=t("fs"),o=t("path"),s=this.toBuffer(...e);a.mkdir(o.dirname(n),{recursive:!0},t=>{t?i(t):a.writeFile(n,s,t=>{t?i(t):r()})})})},o.prototype.toDataURL=function(...t){let{canvas:n}=this;return n.toDataURL(...t)},o.prototype.toBlob=function(...t){let{data:n,type:e}=_.parse(this.toDataURL(...t)),r=It(atob(n));return new Blob([r],{type:e})},o.prototype.toHTMLCanvasElement=function(){let{canvas:t,sizeX:n,sizeY:r}=this,i=e(n,r);return n&&r&&i.getContext("2d").drawImage(t,0,0),i},o.prototype.toHTMLImageElement=function(...t){return W(this.toDataURL(...t))},o.prototype.toOffscreenCanvas=function(){let{canvas:t,sizeX:n,sizeY:e}=this,i=r(n,e);return n&&e&&i.getContext("2d").drawImage(t,0,0),i},o.utils={},o.utils.isDataURL=function(t){return _.isString(t)},o.utils.isURL=function(t){return lt(t)||xt(t)},o}));

!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).DearImage=n()}(this,(function(){"use strict";class t{constructor(t){this.context=t}get canvas(){return this.context.canvas}get sizeX(){return this.canvas.width}get sizeY(){return this.canvas.height}}function n(){try{return document.createElement("canvas")}catch{}throw new Error("HTMLCanvasElement is not supported.")}function e(t){return eval("require")(t)}function r(){try{let{Canvas:t}=e("canvas");return new t}catch{}throw new Error("Canvas is not supported.")}function i(){try{return new OffscreenCanvas}catch{}throw new Error("OffscreenCanvas is not supported.")}function s(){try{return n()}catch{}try{return i()}catch{}return r()}function a(t){return t<0}function o(t){return!a(t)}function u(t){return Number.isFinite(t)&&o(t)}function c(t,n){return u(t)?Math.round(t):n}function l(t){return c(t,0)}function f(t){let{Blob:n}=globalThis;return!!n&&t instanceof n}function h(t){return!t.size}function p(t){let{Buffer:n}=globalThis;return!!n&&t instanceof n}function m(t){return!t.length}function y(t){let{HTMLCanvasElement:n}=globalThis;return!!n&&t instanceof n}function g(t){try{let{Canvas:n}=e("canvas");return t instanceof n}catch{}return!1}function d(t){let{OffscreenCanvas:n}=globalThis;return!!n&&t instanceof n}function w(t){return y(t)||d(t)||g(t)}t.blank=function(t,n){t=l(t),n=l(n);let e=s();return e.width=t,e.height=n,new this(e.getContext("2d"))},t.is=function(t){return t instanceof this};class v{}function z(t){return t instanceof this}function b(t){try{return this.parse(t),!0}catch{return!1}}function x(t){return"string"==typeof t}var I=/^data:(.*?)(;base64)?,(.*)$/;function E(t){if(x(t)){let n=I.exec(t);if(n){let e=n[1],r=n[3];return Object.assign(new this,{type:e,data:r,toString:()=>t})}}throw new Error("Invalid data URL.")}var L={is:z,isString:b,parse:E};function X(){return!this.data}var Y={isEmpty:X};let{prototype:O}=v;function C(){try{return new Image}catch{}throw new Error("HTMLImageElement is not supported.")}function M(){try{let{Image:t}=e("canvas");return new t}catch{}throw new Error("Image is not supported.")}function T(){try{return C()}catch{}return M()}function j(t){let{HTMLImageElement:n}=globalThis;return!!n&&t instanceof n}function U(t){try{let{Image:n}=e("canvas");return t instanceof n}catch{}return!1}function D(t){return j(t)||U(t)}async function R(t){if(!t.complete)try{await new Promise((n,e)=>{t.onload=n,t.onerror=e})}finally{t.onload=null,t.onerror=null}}function S(t){try{let{ImageData:n}=e("canvas");return t instanceof n}catch{}return!1}function k(t){let{ImageData:n}=globalThis;return!!n&&t instanceof n||S(t)}function F(t){let{URL:n}=globalThis;return!!n&&t instanceof n}Object.assign(v,L),Object.assign(O,Y);let B=function(t){let n=this.blank(t.width,t.height);return n.sizeX&&n.sizeY&&n.context.putImageData(t,0,0),n},H=function(t,n,e){let r=this.blank(n,e);return r.sizeX&&r.sizeY&&r.context.drawImage(t,0,0),r},N=function(t){return H.call(this,t,t.width,t.height)},A=function(t){return H.call(this,t,t.naturalWidth,t.naturalHeight)},q=function(t){return N.call(this,t.canvas)},P=function(n){if(t.is(n))return q.call(this,n);if(k(n))return B.call(this,n);if(w(n))return N.call(this,n);if(D(n))return A.call(this,n);throw new Error},W=async function(t){return await R(t),A.call(this,t)},$=async function(t){let n=T();return n.src=t,W.call(this,n)},G=async function(t){return m(t)?this.blank():$.call(this,t)},J=async function(t){if(h(t))return this.blank();let n=URL.createObjectURL(t);try{return $.call(this,n)}finally{URL.revokeObjectURL(n)}},K=async function(t){return t.isEmpty()?this.blank():$.call(this,""+t)},Q=async function(t){try{let n=v.parse(t);return K.call(this,n)}catch{return $.call(this,t)}},V=async function(t){return $.call(this,""+t)},Z=async function(t){return x(t)?Q.call(this,t):F(t)?V.call(this,t):p(t)?G.call(this,t):f(t)?J.call(this,t):D(t)?W.call(this,t):P.call(this,t)};Object.assign(t,{from:P,loadFrom:Z}),t.fromExcept=function(t){return this.is(t)?t:this.from(t)},t.isDearImage=t.is.bind(t);class _{}var tt="sans-serif",nt="normal",et=Object.assign(new _,{family:tt,style:nt,variant:nt,weight:nt});function rt(t){if(t){let n=typeof t;return"object"===n||"function"===n}return!1}function it(t){return void 0===t}function st(t){return!t}function at(t){return!st(t)}function ot(t){return x(t)&&at(t)}function ut(t){if(it(t))return tt;if(ot(t))return t;throw 0}var ct=new Set([nt,"italic","oblique"]);function lt(t){if(it(t))return nt;if(x(t)&&(t=t.trim().toLowerCase(),ct.has(t)))return t;throw 0}var ft=new Set([nt,"small-caps"]);function ht(t){if(it(t))return nt;if(x(t)&&(t=t.trim().toLowerCase(),ft.has(t)))return t;throw 0}function pt(t){return"number"==typeof t&&!Number.isNaN(t)}function mt(t,n,e,r,i){return(r?t>=n:t>n)&&(i?t<=e:t<e)}function yt(t,...n){return pt(t)&&mt(t,...n)}var gt=new Set([nt,"bold"]);function dt(t){if(it(t))return nt;if(x(t)){if(t=t.trim().toLowerCase(),gt.has(t))return t}else if(yt(t,1,1e3,!0,!0))return Math.round(t);throw 0}function wt(t){let n,e,r,i;if(x(t))n=ut(t),e=nt,r=nt,i=nt;else{if(!rt(t))throw new Error("Invalid font face.");({family:n,style:e,variant:r,weight:i}=t),n=ut(n),e=lt(e),r=ht(r),i=dt(i)}return[n,e,r,i]}function vt(t){let[n,e,r,i]=wt(t);return Object.assign(new this,{family:n,style:e,variant:r,weight:i})}function zt(t){return this.is(t)?t:this.from(t)}function bt(t){return t instanceof this}var xt={default:et,from:vt,fromExcept:zt,is:bt};function It(t,n,e,r,i){return[e,r,i,n+"px",t].join(" ")}function Et(t){return null===t}function Lt(t){return it(t)||Et(t)}async function Xt(t){let{family:n,style:r,variant:i,weight:s}=this;if(Lt(t))try{await document.fonts.load(It(n,10,r,i,s))}catch{}else{try{await new FontFace(n,t,{style:r,variant:i,weight:s}).load()}catch{}try{let{registerFont:a}=e("canvas");await a(t,{family:n,style:r,variant:i,weight:s})}catch{}}}var Yt={load:Xt};let{prototype:Ot}=_;Object.assign(_,xt),Object.assign(Ot,Yt),t.loadFontFace=async function(t,n){return _.fromExcept(t).load(n)},t.loadFromExcept=async function(t){return this.is(t)?t:this.loadFrom(t)};class Ct{}var Mt=10;function Tt(t){if(it(t))return Mt;if(u(t))return Math.round(t);throw 0}function jt(t){let n,e;if(!rt(t))throw new Error("Invalid font.");({size:e,...n}=t),e=Tt(e),n=_.from(n);let{family:r,style:i,variant:s,weight:a}=n;return[r,e,i,s,a]}function Ut(t){let[n,e,r,i,s]=jt(t);return Object.assign(new this,{family:n,size:e,style:r,variant:i,weight:s})}function Dt(t){return this.is(t)?t:this.from(t)}function Rt(t){return t instanceof this}var St={from:Ut,fromExcept:Dt,is:Rt};function kt(){let{family:t,size:n,style:e,variant:r,weight:i}=this;return It(t,n,e,r,i)}var Ft={toCSS:kt};let{prototype:Bt}=Ct;function Ht(t){return Lt(t)?"":""+t}Object.assign(Ct,St),Object.assign(Bt,Ft),t.measureText=function(t,n){t=Ht(t);let{context:e}=this.blank();return e.font=Ct.fromExcept(n).toCSS(),e.measureText(t)};var Nt="#000",At=Ct.default,qt=.28;function Pt(t){if(Number.isFinite(t))return Math.round(t)}function Wt(t,n,e){return it(t=Pt(t))?t=0:t<0&&(t+=e),it(n=Pt(n))?n=e:n<0&&(t+=n,n*=-1),[t,n]}function $t(t,...n){return function(...e){return t.call(this,...n,...e)}}t.text=function(t,n){t=Ht(t),[fill=Nt,font=At,padding=qt]=resolveOptions(n),padding=Math.ceil(padding*font.size);let e=this.blank(this.measureText(t,font).width+2*padding,font.size+2*padding),{context:r}=e;return r.save(),r.font=font.toCSS(),r.textBaseline="top",r.textAlign="left",r.fillStyle=fill,r.fillText(t,padding,padding),r.restore(),e},t.prototype.crop=function(t,n,e,r){if([t,e]=Wt(t,e,this.sizeX),[n,r]=Wt(n,r,this.sizeY),t||n||e!==this.sizeX||r!==this.sizeY){let i=this.constructor.blank(e,r);return e&&r&&this.sizeX&&this.sizeY&&i.context.drawImage(this.canvas,-t,-n),i}return this};let Gt=function(t,n){let{sizeX:e,sizeY:r}=this;if(e&&r){let i=this.constructor.blank(e,r),{context:s}=i;return s.save(),s.translate(t?e:0,n?r:0),s.scale(t?-1:1,n?-1:1),s.drawImage(this.canvas,0,0),s.restore(),i}return this};function Jt(t,n,e){switch(t){case"start":return 0;case"end":return-n}return(e+n)/-2}function Kt(t){if(x(t))return t.trim().toLowerCase()}function Qt(t,n,e){return[Jt(t=Kt(t),n=c(n,e),e),n]}function Vt(t,n){return u(t)&&(n*=t),n}function Zt(t,n){return(t=c(t,n))/n}Object.assign(t.prototype,{flipX:$t(Gt,!0,!1),flipY:$t(Gt,!1,!0)}),t.prototype.reframe=function(t,n,e,r){let i,s;return[i,t]=Qt(e,t,this.sizeX),[s,n]=Qt(r,n,this.sizeY),this.crop(i,s,t,n)},t.prototype.resize=function(t,n){if(t=c(t,this.sizeX),n=c(n,this.sizeY),t!==this.sizeX||n!==this.sizeY){let e=this.constructor.blank(t,n);if(t&&n&&this.sizeX&&this.sizeY){let r=t/this.sizeX,i=n/this.sizeY,{context:s}=e;s.save(),s.scale(r,i),s.drawImage(this.canvas,0,0),s.restore()}return e}return this},t.prototype.rescale=function(t,n){let{sizeX:e,sizeY:r}=this;return e=Vt(t,e),r=Vt(n,r),this.resize(e,r)},t.prototype.scale=function(t){return this.rescale(t,t)},t.prototype.resizeX=function(t,n){if(n){let n=Zt(t,this.sizeX);return this.scale(n)}return this.resize(t,this.sizeY)},t.prototype.resizeY=function(t,n){if(n){let n=Zt(t,this.sizeY);return this.scale(n)}return this.resize(this.sizeX,t)},t.prototype.toBuffer=function(...t){return this.sizeX&&this.sizeY?this.canvas.toBuffer(...t):Buffer.alloc(0)},t.prototype.saveToFileSystem=function(t,...n){return new Promise((r,i)=>{let s=e("fs"),a=e("path"),o=this.toBuffer(...n);s.mkdir(a.dirname(t),{recursive:!0},n=>{n?i(n):s.writeFile(t,o,t=>{t?i(t):r()})})})};let _t=function(t,n,e){n=c(n,this.sizeX),e=c(e,this.sizeY);let r=[];if(n&&this.sizeX){let t=n/this.sizeX;r.push(t)}if(e&&this.sizeY){let t=e/this.sizeY;r.push(t)}if(r.length){let n=t(r);return this.scale(n)}return this};function tn(t){let{length:n}=t,e=new Uint8Array(n);for(let r=0;r<n;r++)e[r]=t.charCodeAt(r);return e}function nn(t){if(x(t)){let{URL:n}=globalThis;if(n){let{document:e}=globalThis,r=e&&e.location&&e.location.origin;try{return new n(t,r)}catch{}}}throw new Error("Invalid URL.")}function en(t){try{return nn(t),!0}catch{return!1}}return Object.assign(t.prototype,{scaleDownIn:$t(_t,t=>Math.min(Math.min(...t),1)),scaleDownOut:$t(_t,t=>Math.min(Math.max(...t),1)),scaleIn:$t(_t,t=>Math.min(...t)),scaleOut:$t(_t,t=>Math.max(...t)),scaleUpIn:$t(_t,t=>Math.max(Math.min(...t),1)),scaleUpOut:$t(_t,t=>Math.max(Math.max(...t),1))}),t.prototype.toDataURL=function(...t){return this.canvas.toDataURL(...t)},t.prototype.toBlob=function(...t){let{data:n,type:e}=v.parse(this.toDataURL(...t)),r=tn(atob(n));return new Blob([r],{type:e})},t.prototype.toHTMLCanvasElement=function(){let t=n(),{sizeX:e,sizeY:r}=this;return t.width=e,t.height=r,e&&r&&t.getContext("2d").drawImage(this.canvas,0,0),t},t.prototype.toHTMLImageElement=function(...t){let n=C();return n.src=this.toDataURL(...t),n},t.prototype.toImageData=function(){return this.context.getImageData(0,0,this.sizeX,this.sizeY)},t.prototype.toOffscreenCanvas=function(){let t=i(),{sizeX:n,sizeY:e}=this;return t.width=n,t.height=e,n&&e&&t.getContext("2d").drawImage(this.canvas,0,0),t},t.utils={},t.utils.isDataURL=function(t){return v.is(t)||v.isString(t)},t.utils.isURL=function(t){return F(t)||en(t)},t}));
